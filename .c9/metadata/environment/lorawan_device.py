{"changed":true,"filter":false,"title":"lorawan_device.py","tooltip":"/lorawan_device.py","value":"import os\nimport time\nimport json\nimport random\nimport ssl\nimport paho.mqtt.client as mqtt\nfrom datetime import datetime\n\n# PDATED certificate paths\nCA_PATH = \"certs/AmazonRootCA1.pem\"\nCERT_PATH = \"certs/device-certificate.pem.crt\"\nKEY_PATH = \"certs/private.pem.key\"\n\n# MQTT Configuration\nBROKER = \"a3hyjp4joybycm-ats.iot.us-east-1.amazonaws.com\"  # Replace this\nPORT = 8883\nTOPIC = \"lorawan/traffic\"\n\nclient = mqtt.Client()\n\nclient.tls_set(\n    ca_certs=CA_PATH,\n    certfile=CERT_PATH,\n    keyfile=KEY_PATH,\n    tls_version=ssl.PROTOCOL_TLSv1_2\n)\n\nclient.connect(BROKER, PORT)\nclient.loop_start()\n\nprint(\"🚀 LoRaWAN device started. Publishing traffic data...\")\n\nwhile True:\n    payload = {\n        \"timestamp\": str(datetime.utcnow()),\n        \"location\": {\"lat\": 53.349805, \"lng\": -6.26031},\n        \"vehicle_count\": random.randint(1, 20)\n    }\n    client.publish(TOPIC, json.dumps(payload))\n    print(\"📡 Sent:\", payload)\n    time.sleep(5)\n","undoManager":{"mark":26,"position":26,"stack":[[{"start":{"row":8,"column":0},"end":{"row":10,"column":25},"action":"remove","lines":["MQTT_BROKER = \"127.0.0.1\"","MQTT_PORT = 1883","TOPIC = \"lorawan/traffic\""],"id":5},{"start":{"row":8,"column":0},"end":{"row":11,"column":48},"action":"insert","lines":["CA_PATH = \"certs/AmazonRootCA1.pem\"","CERT_PATH = \"certs/device-certificate.pem.crt\"","KEY_PATH = \"certs/private.pem.key\"","MQTT_BROKER = \"your-iot-endpoint.amazonaws.com\" "]}],[{"start":{"row":11,"column":15},"end":{"row":11,"column":46},"action":"remove","lines":["your-iot-endpoint.amazonaws.com"],"id":6},{"start":{"row":11,"column":15},"end":{"row":11,"column":61},"action":"insert","lines":["a3hyjp4joybycm-ats.iot.us-east-1.amazonaws.com"]}],[{"start":{"row":0,"column":0},"end":{"row":28,"column":0},"action":"remove","lines":["# lorawan_device.py","# Simulates a LoRaWAN end device sending vehicle count data via MQTT","","import json","import time","import paho.mqtt.client as mqtt","from vehicle_detector import detect_vehicles","","CA_PATH = \"certs/AmazonRootCA1.pem\"","CERT_PATH = \"certs/device-certificate.pem.crt\"","KEY_PATH = \"certs/private.pem.key\"","MQTT_BROKER = \"a3hyjp4joybycm-ats.iot.us-east-1.amazonaws.com\" ","","","client = mqtt.Client()","client.connect(MQTT_BROKER, MQTT_PORT, 60)","","print(\"LoRaWAN device started. Sending data to gateway...\")","","try:","    while True:","        data = detect_vehicles()","        print(f\"Sending: {data}\")","        client.publish(TOPIC, json.dumps(data))","        time.sleep(10)  # Simulate LoRa delay","except KeyboardInterrupt:","    print(\"Stopped.\")","    client.disconnect()",""],"id":7},{"start":{"row":0,"column":0},"end":{"row":40,"column":0},"action":"insert","lines":["import json","import time","import ssl","import random","from datetime import datetime","import paho.mqtt.client as mqtt","","# MQTT Config (update endpoint)","MQTT_BROKER = \"YOUR_ENDPOINT.iot.us-east-1.amazonaws.com\"","MQTT_PORT = 8883","MQTT_TOPIC = \"lorawan/traffic\"","","CA_PATH = \"certs/AmazonRootCA1.pem\"","CERT_PATH = \"certs/device-certificate.pem.crt\"","KEY_PATH = \"certs/private.pem.key\"","","def generate_vehicle_data():","    return {","        \"timestamp\": datetime.utcnow().isoformat(),","        \"location\": {\"lat\": 53.349805, \"lng\": -6.26031},","        \"vehicle_count\": random.randint(1, 10)","    }","","client = mqtt.Client()","client.tls_set(ca_certs=CA_PATH, certfile=CERT_PATH, keyfile=KEY_PATH, tls_version=ssl.PROTOCOL_TLSv1_2)","","client.connect(MQTT_BROKER, MQTT_PORT, 60)","client.loop_start()","","print(\"LoRaWAN device started. Sending data to AWS IoT...\")","","try:","    while True:","        data = generate_vehicle_data()","        client.publish(MQTT_TOPIC, json.dumps(data))","        print(\"Sent:\", data)","        time.sleep(5)","except KeyboardInterrupt:","    print(\"Stopped by user.\")","    client.loop_stop()",""]}],[{"start":{"row":8,"column":15},"end":{"row":8,"column":56},"action":"remove","lines":["YOUR_ENDPOINT.iot.us-east-1.amazonaws.com"],"id":8},{"start":{"row":8,"column":15},"end":{"row":8,"column":61},"action":"insert","lines":["a3hyjp4joybycm-ats.iot.us-east-1.amazonaws.com"]}],[{"start":{"row":7,"column":15},"end":{"row":7,"column":31},"action":"remove","lines":["update endpoint)"],"id":10},{"start":{"row":7,"column":14},"end":{"row":7,"column":15},"action":"remove","lines":["("]},{"start":{"row":7,"column":13},"end":{"row":7,"column":14},"action":"remove","lines":[" "]}],[{"start":{"row":0,"column":0},"end":{"row":40,"column":0},"action":"remove","lines":["import json","import time","import ssl","import random","from datetime import datetime","import paho.mqtt.client as mqtt","","# MQTT Config","MQTT_BROKER = \"a3hyjp4joybycm-ats.iot.us-east-1.amazonaws.com\"","MQTT_PORT = 8883","MQTT_TOPIC = \"lorawan/traffic\"","","CA_PATH = \"certs/AmazonRootCA1.pem\"","CERT_PATH = \"certs/device-certificate.pem.crt\"","KEY_PATH = \"certs/private.pem.key\"","","def generate_vehicle_data():","    return {","        \"timestamp\": datetime.utcnow().isoformat(),","        \"location\": {\"lat\": 53.349805, \"lng\": -6.26031},","        \"vehicle_count\": random.randint(1, 10)","    }","","client = mqtt.Client()","client.tls_set(ca_certs=CA_PATH, certfile=CERT_PATH, keyfile=KEY_PATH, tls_version=ssl.PROTOCOL_TLSv1_2)","","client.connect(MQTT_BROKER, MQTT_PORT, 60)","client.loop_start()","","print(\"LoRaWAN device started. Sending data to AWS IoT...\")","","try:","    while True:","        data = generate_vehicle_data()","        client.publish(MQTT_TOPIC, json.dumps(data))","        print(\"Sent:\", data)","        time.sleep(5)","except KeyboardInterrupt:","    print(\"Stopped by user.\")","    client.loop_stop()",""],"id":11}],[{"start":{"row":0,"column":0},"end":{"row":45,"column":0},"action":"insert","lines":["# lorawan_device.py","# Simulated LoRaWAN device using AWS IoT MQTT","","import json","import time","import ssl","import random","from datetime import datetime","import paho.mqtt.client as mqtt","","# AWS IoT MQTT Config","MQTT_BROKER = \"YOUR_ENDPOINT.iot.us-east-1.amazonaws.com\"  # Replace with your AWS IoT endpoint","MQTT_PORT = 8883","MQTT_TOPIC = \"lorawan/traffic\"","","# Paths to AWS IoT Core certificates (update if different)","CA_PATH = \"certs/AmazonRootCA1.pem\"","CERT_PATH = \"certs/device-certificate.pem.crt\"","KEY_PATH = \"certs/private.pem.key\"","","def generate_vehicle_data():","    \"\"\"Generates mock traffic data\"\"\"","    return {","        \"timestamp\": datetime.utcnow().isoformat(),","        \"location\": {\"lat\": 53.349805, \"lng\": -6.26031},","        \"vehicle_count\": random.randint(1, 20)","    }","","# MQTT Client Setup","client = mqtt.Client()","client.tls_set(ca_certs=CA_PATH, certfile=CERT_PATH, keyfile=KEY_PATH, tls_version=ssl.PROTOCOL_TLSv1_2)","client.connect(MQTT_BROKER, MQTT_PORT, 60)","client.loop_start()","","print(\"🚀 LoRaWAN device started. Publishing traffic data...\")","","try:","    while True:","        data = generate_vehicle_data()","        client.publish(MQTT_TOPIC, json.dumps(data))","        print(\"📡 Sent:\", data)","        time.sleep(5)","except KeyboardInterrupt:","    print(\"🔴 Stopped by user.\")","    client.loop_stop()",""],"id":12}],[{"start":{"row":11,"column":15},"end":{"row":11,"column":56},"action":"remove","lines":["YOUR_ENDPOINT.iot.us-east-1.amazonaws.com"],"id":13}],[{"start":{"row":11,"column":15},"end":{"row":11,"column":62},"action":"insert","lines":["a3hyjp4joybycm-ats.iot.us-east-1.amazonaws.com\""],"id":14}],[{"start":{"row":11,"column":62},"end":{"row":11,"column":63},"action":"remove","lines":["\""],"id":15}],[{"start":{"row":11,"column":66},"end":{"row":11,"column":67},"action":"insert","lines":["T"],"id":16},{"start":{"row":11,"column":67},"end":{"row":11,"column":68},"action":"insert","lines":["H"]},{"start":{"row":11,"column":68},"end":{"row":11,"column":69},"action":"insert","lines":["i"]},{"start":{"row":11,"column":69},"end":{"row":11,"column":70},"action":"insert","lines":["s"]}],[{"start":{"row":11,"column":70},"end":{"row":11,"column":71},"action":"insert","lines":[" "],"id":17},{"start":{"row":11,"column":71},"end":{"row":11,"column":72},"action":"insert","lines":["i"]},{"start":{"row":11,"column":72},"end":{"row":11,"column":73},"action":"insert","lines":["s"]}],[{"start":{"row":11,"column":73},"end":{"row":11,"column":74},"action":"insert","lines":[" "],"id":18},{"start":{"row":11,"column":74},"end":{"row":11,"column":75},"action":"insert","lines":["m"]},{"start":{"row":11,"column":75},"end":{"row":11,"column":76},"action":"insert","lines":["y"]}],[{"start":{"row":11,"column":76},"end":{"row":11,"column":77},"action":"insert","lines":[" "],"id":19}],[{"start":{"row":11,"column":67},"end":{"row":11,"column":68},"action":"remove","lines":["H"],"id":20}],[{"start":{"row":11,"column":67},"end":{"row":11,"column":68},"action":"insert","lines":["h"],"id":21}],[{"start":{"row":11,"column":77},"end":{"row":11,"column":78},"action":"insert","lines":["e"],"id":22},{"start":{"row":11,"column":78},"end":{"row":11,"column":79},"action":"insert","lines":["n"]},{"start":{"row":11,"column":79},"end":{"row":11,"column":80},"action":"insert","lines":["d"]},{"start":{"row":11,"column":80},"end":{"row":11,"column":81},"action":"insert","lines":["p"]},{"start":{"row":11,"column":81},"end":{"row":11,"column":82},"action":"insert","lines":["o"]},{"start":{"row":11,"column":82},"end":{"row":11,"column":83},"action":"insert","lines":["j"]}],[{"start":{"row":11,"column":82},"end":{"row":11,"column":83},"action":"remove","lines":["j"],"id":23}],[{"start":{"row":11,"column":82},"end":{"row":11,"column":83},"action":"insert","lines":["o"],"id":24},{"start":{"row":11,"column":83},"end":{"row":11,"column":84},"action":"insert","lines":["n"]}],[{"start":{"row":11,"column":83},"end":{"row":11,"column":84},"action":"remove","lines":["n"],"id":25}],[{"start":{"row":11,"column":83},"end":{"row":11,"column":84},"action":"insert","lines":["i"],"id":26},{"start":{"row":11,"column":84},"end":{"row":11,"column":85},"action":"insert","lines":["n"]},{"start":{"row":11,"column":85},"end":{"row":11,"column":86},"action":"insert","lines":["t"]}],[{"start":{"row":11,"column":86},"end":{"row":11,"column":87},"action":"insert","lines":[" "],"id":27}],[{"start":{"row":0,"column":0},"end":{"row":45,"column":0},"action":"remove","lines":["# lorawan_device.py","# Simulated LoRaWAN device using AWS IoT MQTT","","import json","import time","import ssl","import random","from datetime import datetime","import paho.mqtt.client as mqtt","","# AWS IoT MQTT Config","MQTT_BROKER = \"a3hyjp4joybycm-ats.iot.us-east-1.amazonaws.com\"  # This is my endpooint Replace with your AWS IoT endpoint","MQTT_PORT = 8883","MQTT_TOPIC = \"lorawan/traffic\"","","# Paths to AWS IoT Core certificates (update if different)","CA_PATH = \"certs/AmazonRootCA1.pem\"","CERT_PATH = \"certs/device-certificate.pem.crt\"","KEY_PATH = \"certs/private.pem.key\"","","def generate_vehicle_data():","    \"\"\"Generates mock traffic data\"\"\"","    return {","        \"timestamp\": datetime.utcnow().isoformat(),","        \"location\": {\"lat\": 53.349805, \"lng\": -6.26031},","        \"vehicle_count\": random.randint(1, 20)","    }","","# MQTT Client Setup","client = mqtt.Client()","client.tls_set(ca_certs=CA_PATH, certfile=CERT_PATH, keyfile=KEY_PATH, tls_version=ssl.PROTOCOL_TLSv1_2)","client.connect(MQTT_BROKER, MQTT_PORT, 60)","client.loop_start()","","print(\"🚀 LoRaWAN device started. Publishing traffic data...\")","","try:","    while True:","        data = generate_vehicle_data()","        client.publish(MQTT_TOPIC, json.dumps(data))","        print(\"📡 Sent:\", data)","        time.sleep(5)","except KeyboardInterrupt:","    print(\"🔴 Stopped by user.\")","    client.loop_stop()",""],"id":28},{"start":{"row":0,"column":0},"end":{"row":46,"column":0},"action":"insert","lines":["# lorawan_device.py","import time","import json","import random","import paho.mqtt.client as mqtt","","# MQTT endpoint (replace if you have your own)","BROKER = \"your-iot-endpoint.amazonaws.com\"  # 🔁 Replace this!","PORT = 8883","TOPIC = \"lorawan/traffic\"","","# 🔐 TLS and Auth","CA_PATH = \"AmazonRootCA1.pem\"","CERT_PATH = \"certificate.pem.crt\"","KEY_PATH = \"private.pem.key\"","","# MQTT client setup","client = mqtt.Client()","client.tls_set(ca_certs=CA_PATH, certfile=CERT_PATH, keyfile=KEY_PATH)","","def generate_payload():","    return {","        \"timestamp\": time.strftime(\"%Y-%m-%dT%H:%M:%S\"),","        \"location\": {\"lat\": 53.349805, \"lng\": -6.26031},","        \"vehicle_count\": random.randint(0, 20)","    }","","def on_connect(client, userdata, flags, rc):","    print(\"✅ Connected with result code\", rc)","","client.on_connect = on_connect","client.connect(BROKER, PORT, 60)","client.loop_start()","","print(\"🚀 LoRaWAN device started. Sending traffic data...\")","","try:","    while True:","        payload = generate_payload()","        print(\"📡 Sending:\", payload)","        client.publish(TOPIC, json.dumps(payload))","        time.sleep(5)","except KeyboardInterrupt:","    client.loop_stop()","    client.disconnect()","    print(\"🛑 Disconnected.\")",""]}],[{"start":{"row":7,"column":10},"end":{"row":7,"column":41},"action":"remove","lines":["your-iot-endpoint.amazonaws.com"],"id":29},{"start":{"row":7,"column":10},"end":{"row":7,"column":56},"action":"insert","lines":["a3hyjp4joybycm-ats.iot.us-east-1.amazonaws.com"]}],[{"start":{"row":0,"column":0},"end":{"row":46,"column":0},"action":"remove","lines":["# lorawan_device.py","import time","import json","import random","import paho.mqtt.client as mqtt","","# MQTT endpoint (replace if you have your own)","BROKER = \"a3hyjp4joybycm-ats.iot.us-east-1.amazonaws.com\"  # 🔁 Replace this!","PORT = 8883","TOPIC = \"lorawan/traffic\"","","# 🔐 TLS and Auth","CA_PATH = \"AmazonRootCA1.pem\"","CERT_PATH = \"certificate.pem.crt\"","KEY_PATH = \"private.pem.key\"","","# MQTT client setup","client = mqtt.Client()","client.tls_set(ca_certs=CA_PATH, certfile=CERT_PATH, keyfile=KEY_PATH)","","def generate_payload():","    return {","        \"timestamp\": time.strftime(\"%Y-%m-%dT%H:%M:%S\"),","        \"location\": {\"lat\": 53.349805, \"lng\": -6.26031},","        \"vehicle_count\": random.randint(0, 20)","    }","","def on_connect(client, userdata, flags, rc):","    print(\"✅ Connected with result code\", rc)","","client.on_connect = on_connect","client.connect(BROKER, PORT, 60)","client.loop_start()","","print(\"🚀 LoRaWAN device started. Sending traffic data...\")","","try:","    while True:","        payload = generate_payload()","        print(\"📡 Sending:\", payload)","        client.publish(TOPIC, json.dumps(payload))","        time.sleep(5)","except KeyboardInterrupt:","    client.loop_stop()","    client.disconnect()","    print(\"🛑 Disconnected.\")",""],"id":30},{"start":{"row":0,"column":0},"end":{"row":41,"column":0},"action":"insert","lines":["import os","import time","import json","import random","import ssl","import paho.mqtt.client as mqtt","from datetime import datetime","","# ✅ UPDATED certificate paths","CA_PATH = \"certs/AmazonRootCA1.pem\"","CERT_PATH = \"certs/device-certificate.pem.crt\"","KEY_PATH = \"certs/private.pem.key\"","","# MQTT Configuration","BROKER = \"your-iot-endpoint.amazonaws.com\"  # Replace this","PORT = 8883","TOPIC = \"lorawan/traffic\"","","client = mqtt.Client()","","client.tls_set(","    ca_certs=CA_PATH,","    certfile=CERT_PATH,","    keyfile=KEY_PATH,","    tls_version=ssl.PROTOCOL_TLSv1_2",")","","client.connect(BROKER, PORT)","client.loop_start()","","print(\"🚀 LoRaWAN device started. Publishing traffic data...\")","","while True:","    payload = {","        \"timestamp\": str(datetime.utcnow()),","        \"location\": {\"lat\": 53.349805, \"lng\": -6.26031},","        \"vehicle_count\": random.randint(1, 20)","    }","    client.publish(TOPIC, json.dumps(payload))","    print(\"📡 Sent:\", payload)","    time.sleep(5)",""]}],[{"start":{"row":14,"column":10},"end":{"row":14,"column":41},"action":"remove","lines":["your-iot-endpoint.amazonaws.com"],"id":31},{"start":{"row":14,"column":10},"end":{"row":14,"column":56},"action":"insert","lines":["a3hyjp4joybycm-ats.iot.us-east-1.amazonaws.com"]}],[{"start":{"row":8,"column":4},"end":{"row":8,"column":5},"action":"remove","lines":["U"],"id":32},{"start":{"row":8,"column":3},"end":{"row":8,"column":4},"action":"remove","lines":[" "]},{"start":{"row":8,"column":2},"end":{"row":8,"column":3},"action":"remove","lines":["✅"]}],[{"start":{"row":0,"column":0},"end":{"row":96,"column":10},"action":"remove","lines":["# lorawan.py","# Simulates a LoRaWAN device publishing traffic data to AWS IoT Core","","import os","import time","import json","import random","import ssl","import paho.mqtt.client as mqtt","from datetime import datetime, timezone","","# Configuration","CA_PATH = \"certs/AmazonRootCA1.pem\"","CERT_PATH = \"certs/device-certificate.pem.crt\"","KEY_PATH = \"certs/private.pem.key\"","BROKER = \"a3hyjp4joybycm-ats.iot.us-east-1.amazonaws.com\"","PORT = 8883","TOPIC = \"lorawan/traffic\"","PUBLISH_INTERVAL = 5  # seconds","","# Dublin coordinates as default","DEFAULT_LOCATION = {\"lat\": 53.349805, \"lng\": -6.26031}","","def on_connect(client, userdata, flags, rc, properties=None):","    if rc == 0:","        print(\"✅ Connected to AWS IoT Core successfully\")","    else:","        print(f\"❌ Connection failed with result code {rc}\")","        # Attempt to reconnect","        client.reconnect()","","def on_disconnect(client, userdata, rc):","    print(f\"⚠️ Disconnected from broker (rc: {rc})\")","    if rc != 0:","        print(\"⏳ Attempting to reconnect...\")","        time.sleep(5)","        client.reconnect()","","def create_mqtt_client():","    \"\"\"Create and configure MQTT client\"\"\"","    client = mqtt.Client(mqtt.CallbackAPIVersion.VERSION2)","    ","    # Assign callbacks","    client.on_connect = on_connect","    client.on_disconnect = on_disconnect","    ","    # Configure TLS","    client.tls_set(","        ca_certs=CA_PATH,","        certfile=CERT_PATH,","        keyfile=KEY_PATH,","        tls_version=ssl.PROTOCOL_TLSv1_2","    )","    ","    return client","","def generate_payload():","    \"\"\"Generate simulated traffic data payload\"\"\"","    return {","        \"timestamp\": datetime.now(timezone.utc).isoformat(),","        \"location\": DEFAULT_LOCATION,","        \"vehicle_count\": random.randint(1, 20)","    }","","def main():","    print(\"🚀 Starting LoRaWAN device simulator...\")","    ","    try:","        client = create_mqtt_client()","        client.connect(BROKER, PORT, 60)","        client.loop_start()","        ","        print(f\"📡 Publishing to topic: {TOPIC} every {PUBLISH_INTERVAL} seconds\")","        print(\"Press Ctrl+C to stop...\\n\")","        ","        while True:","            payload = generate_payload()","            result = client.publish(TOPIC, json.dumps(payload))","            ","            if result.rc == mqtt.MQTT_ERR_SUCCESS:","                print(f\"📦 Published: {payload}\")","            else:","                print(f\"❌ Failed to publish (rc: {result.rc})\")","            ","            time.sleep(PUBLISH_INTERVAL)","            ","    except KeyboardInterrupt:","        print(\"\\n🛑 Received shutdown signal, stopping...\")","    except Exception as e:","        print(f\"❌ Unexpected error: {str(e)}\")","    finally:","        client.loop_stop()","        client.disconnect()","        print(\"🔌 Disconnected from MQTT broker\")","","if __name__ == \"__main__\":","    main()"],"id":35},{"start":{"row":0,"column":0},"end":{"row":116,"column":10},"action":"insert","lines":["# lorawan.py","# Simulates a LoRaWAN device publishing traffic data to AWS IoT Core","","import os","import time","import json","import random","import ssl","import paho.mqtt.client as mqtt","from datetime import datetime, timezone","","# Configuration","CA_PATH = \"certs/AmazonRootCA1.pem\"","CERT_PATH = \"certs/device-certificate.pem.crt\"","KEY_PATH = \"certs/private.pem.key\"","BROKER = \"a3hyjp4joybycm-ats.iot.us-east-1.amazonaws.com\"","PORT = 8883","TOPIC = \"lorawan/traffic\"","PUBLISH_INTERVAL = 5  # seconds","","# Dublin coordinates as default","DEFAULT_LOCATION = {\"lat\": 53.349805, \"lng\": -6.26031}","","def on_connect(client, userdata, flags, rc, properties=None):","    \"\"\"Callback for when the client receives a CONNACK response from the server.\"\"\"","    if rc == 0:","        print(\"✅ Connected to AWS IoT Core successfully\")","    else:","        print(f\"❌ Connection failed with result code {rc}\")","        # Attempt to reconnect","        time.sleep(5)","        client.reconnect()","","def on_disconnect(client, userdata, rc, properties=None):","    \"\"\"Callback for when the client disconnects from the broker.\"\"\"","    print(f\"⚠️ Disconnected from broker (rc: {rc})\")","    if rc != 0:","        print(\"⏳ Attempting to reconnect...\")","        time.sleep(5)","        client.reconnect()","","def create_mqtt_client():","    \"\"\"Create and configure MQTT client\"\"\"","    client = mqtt.Client(mqtt.CallbackAPIVersion.VERSION2)","    ","    # Assign callbacks","    client.on_connect = on_connect","    client.on_disconnect = on_disconnect","    ","    # Configure TLS","    client.tls_set(","        ca_certs=CA_PATH,","        certfile=CERT_PATH,","        keyfile=KEY_PATH,","        tls_version=ssl.PROTOCOL_TLSv1_2","    )","    ","    # Enable automatic reconnect","    client.reconnect_delay_set(min_delay=1, max_delay=120)","    ","    return client","","def generate_payload():","    \"\"\"Generate simulated traffic data payload\"\"\"","    return {","        \"timestamp\": datetime.now(timezone.utc).isoformat(),","        \"location\": DEFAULT_LOCATION,","        \"vehicle_count\": random.randint(1, 20)","    }","","def main():","    print(\"🚀 Starting LoRaWAN device simulator...\")","    ","    try:","        client = create_mqtt_client()","        ","        # Connect with timeout","        print(f\"🔌 Connecting to {BROKER}...\")","        client.connect(BROKER, PORT, keepalive=60)","        client.loop_start()","        ","        print(f\"📡 Publishing to topic: {TOPIC} every {PUBLISH_INTERVAL} seconds\")","        print(\"Press Ctrl+C to stop...\\n\")","        ","        while True:","            try:","                payload = generate_payload()","                result = client.publish(TOPIC, json.dumps(payload))","                ","                if result.rc == mqtt.MQTT_ERR_SUCCESS:","                    print(f\"📦 Published: {payload}\")","                else:","                    print(f\"❌ Failed to publish (rc: {result.rc})\")","                    # Check connection status and attempt reconnect if needed","                    if not client.is_connected():","                        print(\"⚠️ Connection lost, attempting to reconnect...\")","                        client.reconnect()","                ","                time.sleep(PUBLISH_INTERVAL)","                ","            except KeyboardInterrupt:","                raise","            except Exception as e:","                print(f\"⚠️ Error during publish: {str(e)}\")","                time.sleep(PUBLISH_INTERVAL)  # Prevent tight loop on errors","            ","    except KeyboardInterrupt:","        print(\"\\n🛑 Received shutdown signal, stopping...\")","    except Exception as e:","        print(f\"❌ Unexpected error: {str(e)}\")","    finally:","        client.loop_stop()","        client.disconnect()","        print(\"🔌 Disconnected from MQTT broker\")","","if __name__ == \"__main__\":","    main()"]}],[{"start":{"row":0,"column":0},"end":{"row":41,"column":0},"action":"remove","lines":["import os","import time","import json","import random","import ssl","import paho.mqtt.client as mqtt","from datetime import datetime","","# UPDATED certificate paths","CA_PATH = \"certs/AmazonRootCA1.pem\"","CERT_PATH = \"certs/device-certificate.pem.crt\"","KEY_PATH = \"certs/private.pem.key\"","","# MQTT Configuration","BROKER = \"a3hyjp4joybycm-ats.iot.us-east-1.amazonaws.com\"  # Replace this","PORT = 8883","TOPIC = \"lorawan/traffic\"","","client = mqtt.Client()","","client.tls_set(","    ca_certs=CA_PATH,","    certfile=CERT_PATH,","    keyfile=KEY_PATH,","    tls_version=ssl.PROTOCOL_TLSv1_2",")","","client.connect(BROKER, PORT)","client.loop_start()","","print(\"🚀 LoRaWAN device started. Publishing traffic data...\")","","while True:","    payload = {","        \"timestamp\": str(datetime.utcnow()),","        \"location\": {\"lat\": 53.349805, \"lng\": -6.26031},","        \"vehicle_count\": random.randint(1, 20)","    }","    client.publish(TOPIC, json.dumps(payload))","    print(\"📡 Sent:\", payload)","    time.sleep(5)",""],"id":35},{"start":{"row":0,"column":0},"end":{"row":96,"column":10},"action":"insert","lines":["# lorawan.py","# Simulates a LoRaWAN device publishing traffic data to AWS IoT Core","","import os","import time","import json","import random","import ssl","import paho.mqtt.client as mqtt","from datetime import datetime, timezone","","# Configuration","CA_PATH = \"certs/AmazonRootCA1.pem\"","CERT_PATH = \"certs/device-certificate.pem.crt\"","KEY_PATH = \"certs/private.pem.key\"","BROKER = \"a3hyjp4joybycm-ats.iot.us-east-1.amazonaws.com\"","PORT = 8883","TOPIC = \"lorawan/traffic\"","PUBLISH_INTERVAL = 5  # seconds","","# Dublin coordinates as default","DEFAULT_LOCATION = {\"lat\": 53.349805, \"lng\": -6.26031}","","def on_connect(client, userdata, flags, rc, properties=None):","    if rc == 0:","        print(\"✅ Connected to AWS IoT Core successfully\")","    else:","        print(f\"❌ Connection failed with result code {rc}\")","        # Attempt to reconnect","        client.reconnect()","","def on_disconnect(client, userdata, rc):","    print(f\"⚠️ Disconnected from broker (rc: {rc})\")","    if rc != 0:","        print(\"⏳ Attempting to reconnect...\")","        time.sleep(5)","        client.reconnect()","","def create_mqtt_client():","    \"\"\"Create and configure MQTT client\"\"\"","    client = mqtt.Client(mqtt.CallbackAPIVersion.VERSION2)","    ","    # Assign callbacks","    client.on_connect = on_connect","    client.on_disconnect = on_disconnect","    ","    # Configure TLS","    client.tls_set(","        ca_certs=CA_PATH,","        certfile=CERT_PATH,","        keyfile=KEY_PATH,","        tls_version=ssl.PROTOCOL_TLSv1_2","    )","    ","    return client","","def generate_payload():","    \"\"\"Generate simulated traffic data payload\"\"\"","    return {","        \"timestamp\": datetime.now(timezone.utc).isoformat(),","        \"location\": DEFAULT_LOCATION,","        \"vehicle_count\": random.randint(1, 20)","    }","","def main():","    print(\"🚀 Starting LoRaWAN device simulator...\")","    ","    try:","        client = create_mqtt_client()","        client.connect(BROKER, PORT, 60)","        client.loop_start()","        ","        print(f\"📡 Publishing to topic: {TOPIC} every {PUBLISH_INTERVAL} seconds\")","        print(\"Press Ctrl+C to stop...\\n\")","        ","        while True:","            payload = generate_payload()","            result = client.publish(TOPIC, json.dumps(payload))","            ","            if result.rc == mqtt.MQTT_ERR_SUCCESS:","                print(f\"📦 Published: {payload}\")","            else:","                print(f\"❌ Failed to publish (rc: {result.rc})\")","            ","            time.sleep(PUBLISH_INTERVAL)","            ","    except KeyboardInterrupt:","        print(\"\\n🛑 Received shutdown signal, stopping...\")","    except Exception as e:","        print(f\"❌ Unexpected error: {str(e)}\")","    finally:","        client.loop_stop()","        client.disconnect()","        print(\"🔌 Disconnected from MQTT broker\")","","if __name__ == \"__main__\":","    main()"]}],[{"start":{"row":8,"column":2},"end":{"row":8,"column":3},"action":"insert","lines":["U"],"id":36}]]},"ace":{"folds":[],"scrolltop":125.39999999999998,"scrollleft":0,"selection":{"start":{"row":40,"column":17},"end":{"row":40,"column":17},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":7,"state":"start","mode":"ace/mode/python"}},"timestamp":1754653656213}