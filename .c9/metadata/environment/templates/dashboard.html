{"changed":true,"filter":false,"title":"dashboard.html","tooltip":"/templates/dashboard.html","value":"<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>LoRaWAN Traffic Dashboard</title>\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n    <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\"/>\n    <style>\n        body {\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            background-color: #f5f5f5;\n        }\n        .dashboard-header {\n            background-color: #2c3e50;\n            color: white;\n            padding: 20px 0;\n            margin-bottom: 30px;\n        }\n        .card {\n            box-shadow: 0 4px 8px rgba(0,0,0,0.1);\n            margin-bottom: 20px;\n            border: none;\n        }\n        .card-header {\n            background-color: #3498db;\n            color: white;\n            font-weight: bold;\n        }\n        #map {\n            height: 500px;\n            border-radius: 4px;\n        }\n        .traffic-indicator {\n            font-size: 24px;\n            font-weight: bold;\n            padding: 10px;\n            border-radius: 4px;\n            text-align: center;\n            margin-bottom: 15px;\n        }\n        .traffic-low {\n            background-color: #2ecc71;\n            color: white;\n        }\n        .traffic-medium {\n            background-color: #f39c12;\n            color: white;\n        }\n        .traffic-high {\n            background-color: #e74c3c;\n            color: white;\n        }\n        .vehicle-marker {\n            background-color: rgba(231, 76, 60, 0.8);\n            border-radius: 50%;\n            width: 20px;\n            height: 20px;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            color: white;\n            font-weight: bold;\n            font-size: 12px;\n        }\n        .gateway-marker {\n            background-color: rgba(52, 152, 219, 0.8);\n            border-radius: 50%;\n            width: 30px;\n            height: 30px;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            color: white;\n            font-weight: bold;\n            font-size: 12px;\n        }\n        #connection-status {\n            position: absolute;\n            top: 20px;\n            right: 20px;\n            font-size: 14px;\n        }\n        .last-update {\n            font-size: 12px;\n            color: #7f8c8d;\n            text-align: right;\n            margin-top: 5px;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"dashboard-header\">\n        <div class=\"container position-relative\">\n            <h1>LoRaWAN Traffic Monitoring</h1>\n            <p>Real-time vehicle tracking from gateways</p>\n            <div id=\"connection-status\" class=\"badge bg-secondary\">Connecting...</div>\n        </div>\n    </div>\n\n    <div class=\"container\">\n        <div class=\"row\">\n            <div class=\"col-md-8\">\n                <div class=\"card\">\n                    <div class=\"card-header\">Traffic Map</div>\n                    <div class=\"card-body\">\n                        <div id=\"map\"></div>\n                        <div class=\"last-update\" id=\"last-update\">No updates yet</div>\n                    </div>\n                </div>\n            </div>\n            <div class=\"col-md-4\">\n                <div class=\"card\">\n                    <div class=\"card-header\">Traffic Status</div>\n                    <div class=\"card-body\">\n                        <div id=\"traffic-indicator\" class=\"traffic-low traffic-indicator\">\n                            <span id=\"traffic-level-text\">LOW</span> TRAFFIC\n                        </div>\n                        <div id=\"vehicle-count\" class=\"h4 text-center\">0 vehicles detected</div>\n                        <div class=\"mt-3\">\n                            <h5>Active Gateways</h5>\n                            <ul id=\"gateway-list\" class=\"list-group\">\n                                <li class=\"list-group-item\">No gateways active</li>\n                            </ul>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\n    <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\n    <script src=\"https://cdn.socket.io/4.7.4/socket.io.min.js\"></script>\n    <script>\n        // Initialize map\n        const map = L.map('map').setView([0, 0], 2);\n        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n            attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'\n        }).addTo(map);\n\n        // Store markers and data\n        const vehicleMarkers = {};\n        const gatewayMarkers = {};\n        let lastUpdateTime = null;\n        let totalVehicles = 0;\n        let activeGateways = new Set();\n\n        // Connect to Socket.IO server with enhanced configuration\n        const socket = io({\n            reconnection: true,\n            reconnectionAttempts: 5,\n            reconnectionDelay: 1000,\n            timeout: 20000,\n            transports: ['websocket']\n        });\n\n        // Connection status handling\n        socket.on('connect', () => {\n            console.log('‚úÖ Connected to server with ID:', socket.id);\n            document.getElementById('connection-status').className = 'badge bg-success';\n            document.getElementById('connection-status').textContent = 'Connected';\n        });\n\n        socket.on('connect_error', (err) => {\n            console.error('‚ùå Connection error:', err.message);\n            document.getElementById('connection-status').className = 'badge bg-danger';\n            document.getElementById('connection-status').textContent = 'Connection Failed';\n        });\n\n        socket.on('disconnect', (reason) => {\n            console.log('‚ö†Ô∏è Disconnected:', reason);\n            document.getElementById('connection-status').className = 'badge bg-warning';\n            document.getElementById('connection-status').textContent = 'Disconnected';\n            \n            if (reason === 'io server disconnect') {\n                socket.connect();\n            }\n        });\n\n        // Handle updates\n        socket.on('update', (data) => {\n            try {\n                console.log('üîÑ Update:', data);\n                \n                // Validate and prepare data\n                const safeData = {\n                    timestamp: data.timestamp || new Date().toISOString(),\n                    lat: parseFloat(data.lat) || 0,\n                    lng: parseFloat(data.lng) || 0,\n                    vehicle_count: parseInt(data.vehicle_count) || 0,\n                    gateway: data.gateway || 'unknown',\n                    traffic_level: data.traffic_level || 'LOW'\n                };\n\n                // Update UI\n                lastUpdateTime = new Date();\n                document.getElementById('last-update').textContent = `Last update: ${lastUpdateTime.toLocaleTimeString()}`;\n                \n                updateTrafficStatus(safeData.vehicle_count, safeData.traffic_level);\n                updateGatewayList(safeData.gateway);\n                updateMapMarkers(safeData);\n            } catch (error) {\n                console.error('‚ùå Error processing update:', error);\n            }\n        });\n\n        function updateTrafficStatus(count, level) {\n            totalVehicles = count;\n            const indicator = document.getElementById('traffic-indicator');\n            const levelText = document.getElementById('traffic-level-text');\n            \n            indicator.classList.remove('traffic-low', 'traffic-medium', 'traffic-high');\n            \n            if (level === 'LOW') {\n                indicator.classList.add('traffic-low');\n                levelText.textContent = 'LOW';\n            } else if (level === 'MEDIUM') {\n                indicator.classList.add('traffic-medium');\n                levelText.textContent = 'MEDIUM';\n            } else {\n                indicator.classList.add('traffic-high');\n                levelText.textContent = 'HEAVY';\n            }\n            \n            document.getElementById('vehicle-count').textContent = \n                `${count} vehicle${count !== 1 ? 's' : ''} detected`;\n        }\n\n        function updateGatewayList(gatewayId) {\n            if (gatewayId) {\n                activeGateways.add(gatewayId);\n            }\n            \n            const gatewayList = document.getElementById('gateway-list');\n            gatewayList.innerHTML = '';\n            \n            if (activeGateways.size === 0) {\n                gatewayList.innerHTML = '<li class=\"list-group-item\">No gateways active</li>';\n            } else {\n                Array.from(activeGateways).sort().forEach(gateway => {\n                    const item = document.createElement('li');\n                    item.className = 'list-group-item d-flex justify-content-between align-items-center';\n                    item.innerHTML = `\n                        ${gateway}\n                        <span class=\"badge bg-primary rounded-pill\">Active</span>\n                    `;\n                    gatewayList.appendChild(item);\n                });\n            }\n        }\n\n        function updateMapMarkers(data) {\n            const lat = data.lat;\n            const lng = data.lng;\n            const vehicle_count = data.vehicle_count;\n            const gateway = data.gateway || 'unknown';\n            const traffic_level = data.traffic_level || 'LOW';\n            \n            // Vehicle marker\n            if (!vehicleMarkers[gateway]) {\n                const marker = L.marker([lat, lng], {\n                    icon: L.divIcon({\n                        className: 'vehicle-marker',\n                        html: vehicle_count,\n                        iconSize: [20, 20]\n                    })\n                }).addTo(map);\n                \n                marker.bindPopup(`\n                    <strong>Gateway:</strong> ${gateway}<br>\n                    <strong>Vehicles:</strong> ${vehicle_count}<br>\n                    <strong>Status:</strong> ${traffic_level}<br>\n                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}<br>\n                    <strong>Time:</strong> ${new Date(data.timestamp).toLocaleTimeString()}\n                `);\n                \n                vehicleMarkers[gateway] = marker;\n            } else {\n                vehicleMarkers[gateway].setLatLng([lat, lng]);\n                vehicleMarkers[gateway]._icon.innerHTML = vehicle_count;\n                vehicleMarkers[gateway].setPopupContent(`\n                    <strong>Gateway:</strong> ${gateway}<br>\n                    <strong>Vehicles:</strong> ${vehicle_count}<br>\n                    <strong>Status:</strong> ${traffic_level}<br>\n                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}<br>\n                    <strong>Time:</strong> ${new Date(data.timestamp).toLocaleTimeString()}\n                `);\n            }\n            \n            // Gateway marker\n            if (!gatewayMarkers[gateway]) {\n                const marker = L.marker([lat, lng], {\n                    icon: L.divIcon({\n                        className: 'gateway-marker',\n                        html: 'GW',\n                        iconSize: [30, 30]\n                    })\n                }).addTo(map);\n                \n                marker.bindPopup(`\n                    <strong>Gateway:</strong> ${gateway}<br>\n                    <strong>Last Update:</strong> ${new Date(data.timestamp).toLocaleTimeString()}<br>\n                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}\n                `);\n                \n                gatewayMarkers[gateway] = marker;\n            } else {\n                gatewayMarkers[gateway].setLatLng([lat, lng]);\n                gatewayMarkers[gateway].setPopupContent(`\n                    <strong>Gateway:</strong> ${gateway}<br>\n                    <strong>Last Update:</strong> ${new Date(data.timestamp).toLocaleTimeString()}<br>\n                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}\n                `);\n            }\n            \n            map.setView([lat, lng], 15);\n        }\n\n        // Initial setup\n        document.addEventListener('DOMContentLoaded', () => {\n            console.log('Dashboard initialized');\n            \n            setTimeout(() => {\n                if (!socket.connected) {\n                    console.error('‚ùå No connection after 5 seconds');\n                    document.getElementById('connection-status').className = 'badge bg-danger';\n                    document.getElementById('connection-status').textContent = 'Connection Failed';\n                    socket.connect();\n                }\n            }, 5000);\n        });\n    </script>\n</body>\n</html>","undoManager":{"mark":15,"position":15,"stack":[[{"start":{"row":0,"column":0},"end":{"row":0,"column":10},"action":"insert","lines":["index.html"],"id":32}],[{"start":{"row":0,"column":0},"end":{"row":0,"column":10},"action":"remove","lines":["index.html"],"id":33}],[{"start":{"row":0,"column":0},"end":{"row":23,"column":0},"action":"insert","lines":["<!DOCTYPE html>","<html>","<head>","  <title>LoRaWAN Traffic Dashboard</title>","  <script>","    async function loadData() {","      const res = await fetch('/data');","      const data = await res.json();","      const container = document.getElementById('log');","      container.innerHTML = data.map(d => `","        <div>","          <b>${d.gateway_id}</b> @ ${d.timestamp} ‚Üí Count: ${d.vehicle_count}","        </div>`).join('');","    }","    setInterval(loadData, 3000);","    window.onload = loadData;","  </script>","</head>","<body>","  <h1>üö¶ LoRaWAN Vehicle Traffic Dashboard</h1>","  <div id=\"log\">Loading...</div>","</body>","</html>",""],"id":34}],[{"start":{"row":7,"column":36},"end":{"row":7,"column":37},"action":"insert","lines":[" "],"id":35}],[{"start":{"row":0,"column":0},"end":{"row":23,"column":0},"action":"remove","lines":["<!DOCTYPE html>","<html>","<head>","  <title>LoRaWAN Traffic Dashboard</title>","  <script>","    async function loadData() {","      const res = await fetch('/data');","      const data = await res.json(); ","      const container = document.getElementById('log');","      container.innerHTML = data.map(d => `","        <div>","          <b>${d.gateway_id}</b> @ ${d.timestamp} ‚Üí Count: ${d.vehicle_count}","        </div>`).join('');","    }","    setInterval(loadData, 3000);","    window.onload = loadData;","  </script>","</head>","<body>","  <h1>üö¶ LoRaWAN Vehicle Traffic Dashboard</h1>","  <div id=\"log\">Loading...</div>","</body>","</html>",""],"id":36},{"start":{"row":0,"column":0},"end":{"row":48,"column":7},"action":"insert","lines":["<!DOCTYPE html>","<html lang=\"en\">","<head>","    <meta charset=\"UTF-8\">","    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">","    <title>LoRaWAN Traffic Dashboard</title>","    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">","    <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\"/>","    <link rel=\"stylesheet\" href=\"{{ url_for('static', filename='css/styles.css') }}\">","</head>","<body>","    <div class=\"dashboard-header\">","        <div class=\"container\">","            <h1>LoRaWAN Traffic Monitoring</h1>","            <p>Real-time vehicle tracking</p>","            <div id=\"connection-status\" class=\"badge bg-success\">Connected</div>","        </div>","    </div>","","    <div class=\"container\">","        <div class=\"row\">","            <div class=\"col-md-8\">","                <div class=\"card\">","                    <div class=\"card-header\">Traffic Map</div>","                    <div class=\"card-body\">","                        <div id=\"map\" style=\"height: 400px;\"></div>","                    </div>","                </div>","            </div>","            <div class=\"col-md-4\">","                <div class=\"card\">","                    <div class=\"card-header\">Traffic Status</div>","                    <div class=\"card-body\">","                        <div id=\"current-traffic\"></div>","                        <div id=\"vehicle-count\">0 vehicles</div>","                    </div>","                </div>","            </div>","        </div>","","        <!-- Additional dashboard components here -->","    </div>","","    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>","    <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>","    <script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>","    <script src=\"{{ url_for('static', filename='js/dashboard.js') }}\"></script>","</body>","</html>"]}],[{"start":{"row":0,"column":0},"end":{"row":48,"column":7},"action":"remove","lines":["<!DOCTYPE html>","<html lang=\"en\">","<head>","    <meta charset=\"UTF-8\">","    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">","    <title>LoRaWAN Traffic Dashboard</title>","    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">","    <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\"/>","    <link rel=\"stylesheet\" href=\"{{ url_for('static', filename='css/styles.css') }}\">","</head>","<body>","    <div class=\"dashboard-header\">","        <div class=\"container\">","            <h1>LoRaWAN Traffic Monitoring</h1>","            <p>Real-time vehicle tracking</p>","            <div id=\"connection-status\" class=\"badge bg-success\">Connected</div>","        </div>","    </div>","","    <div class=\"container\">","        <div class=\"row\">","            <div class=\"col-md-8\">","                <div class=\"card\">","                    <div class=\"card-header\">Traffic Map</div>","                    <div class=\"card-body\">","                        <div id=\"map\" style=\"height: 400px;\"></div>","                    </div>","                </div>","            </div>","            <div class=\"col-md-4\">","                <div class=\"card\">","                    <div class=\"card-header\">Traffic Status</div>","                    <div class=\"card-body\">","                        <div id=\"current-traffic\"></div>","                        <div id=\"vehicle-count\">0 vehicles</div>","                    </div>","                </div>","            </div>","        </div>","","        <!-- Additional dashboard components here -->","    </div>","","    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>","    <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>","    <script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>","    <script src=\"{{ url_for('static', filename='js/dashboard.js') }}\"></script>","</body>","</html>"],"id":37}],[{"start":{"row":0,"column":0},"end":{"row":373,"column":7},"action":"insert","lines":["<!DOCTYPE html>","<html lang=\"en\">","<head>","    <meta charset=\"UTF-8\">","    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">","    <title>LoRaWAN Traffic Dashboard</title>","    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">","    <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\"/>","    <style>","        body {","            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;","            background-color: #f5f5f5;","        }","        .dashboard-header {","            background-color: #2c3e50;","            color: white;","            padding: 20px 0;","            margin-bottom: 30px;","        }","        .card {","            box-shadow: 0 4px 8px rgba(0,0,0,0.1);","            margin-bottom: 20px;","            border: none;","        }","        .card-header {","            background-color: #3498db;","            color: white;","            font-weight: bold;","        }","        #map {","            height: 500px;","            border-radius: 4px;","        }","        .traffic-indicator {","            font-size: 24px;","            font-weight: bold;","            padding: 10px;","            border-radius: 4px;","            text-align: center;","            margin-bottom: 15px;","        }","        .traffic-low {","            background-color: #2ecc71;","            color: white;","        }","        .traffic-medium {","            background-color: #f39c12;","            color: white;","        }","        .traffic-high {","            background-color: #e74c3c;","            color: white;","        }","        .vehicle-marker {","            background-color: rgba(231, 76, 60, 0.8);","            border-radius: 50%;","            width: 20px;","            height: 20px;","            display: flex;","            justify-content: center;","            align-items: center;","            color: white;","            font-weight: bold;","            font-size: 12px;","        }","        .gateway-marker {","            background-color: rgba(52, 152, 219, 0.8);","            border-radius: 50%;","            width: 30px;","            height: 30px;","            display: flex;","            justify-content: center;","            align-items: center;","            color: white;","            font-weight: bold;","            font-size: 12px;","        }","        #connection-status {","            position: absolute;","            top: 20px;","            right: 20px;","            font-size: 14px;","        }","        .last-update {","            font-size: 12px;","            color: #7f8c8d;","            text-align: right;","            margin-top: 5px;","        }","    </style>","</head>","<body>","    <div class=\"dashboard-header\">","        <div class=\"container position-relative\">","            <h1>LoRaWAN Traffic Monitoring</h1>","            <p>Real-time vehicle tracking from gateways</p>","            <div id=\"connection-status\" class=\"badge bg-secondary\">Connecting...</div>","        </div>","    </div>","","    <div class=\"container\">","        <div class=\"row\">","            <div class=\"col-md-8\">","                <div class=\"card\">","                    <div class=\"card-header\">Traffic Map</div>","                    <div class=\"card-body\">","                        <div id=\"map\"></div>","                        <div class=\"last-update\" id=\"last-update\">No updates yet</div>","                    </div>","                </div>","            </div>","            <div class=\"col-md-4\">","                <div class=\"card\">","                    <div class=\"card-header\">Traffic Status</div>","                    <div class=\"card-body\">","                        <div id=\"traffic-indicator\" class=\"traffic-low traffic-indicator\">","                            <span id=\"traffic-level-text\">LOW</span> TRAFFIC","                        </div>","                        <div id=\"vehicle-count\" class=\"h4 text-center\">0 vehicles detected</div>","                        <div class=\"mt-3\">","                            <h5>Active Gateways</h5>","                            <ul id=\"gateway-list\" class=\"list-group\">","                                <li class=\"list-group-item\">No gateways active</li>","                            </ul>","                        </div>","                    </div>","                </div>","            </div>","        </div>","","        <div class=\"row mt-4\">","            <div class=\"col-12\">","                <div class=\"card\">","                    <div class=\"card-header\">Recent Traffic Events</div>","                    <div class=\"card-body\">","                        <table class=\"table table-striped\">","                            <thead>","                                <tr>","                                    <th>Time</th>","                                    <th>Gateway</th>","                                    <th>Location</th>","                                    <th>Vehicle Count</th>","                                    <th>Status</th>","                                </tr>","                            </thead>","                            <tbody id=\"event-log\">","                                <tr>","                                    <td colspan=\"5\" class=\"text-center\">Waiting for data...</td>","                                </tr>","                            </tbody>","                        </table>","                    </div>","                </div>","            </div>","        </div>","    </div>","","    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>","    <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>","    <script src=\"https://cdn.socket.io/4.7.4/socket.io.min.js\"></script>","    <script>","        // Initialize map","        const map = L.map('map').setView([0, 0], 2);","        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {","            attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'","        }).addTo(map);","","        // Store markers and data","        const vehicleMarkers = {};","        const gatewayMarkers = {};","        let lastUpdateTime = null;","        let totalVehicles = 0;","        let activeGateways = new Set();","","        // Connect to Socket.IO server","        const socket = io();","        ","        socket.on('connect', () => {","            console.log('Connected to fog handler');","            document.getElementById('connection-status').className = 'badge bg-success';","            document.getElementById('connection-status').textContent = 'Connected';","        });","","        socket.on('disconnect', () => {","            console.log('Disconnected from fog handler');","            document.getElementById('connection-status').className = 'badge bg-danger';","            document.getElementById('connection-status').textContent = 'Disconnected';","        });","","        socket.on('update', (data) => {","            // Update last update time","            lastUpdateTime = new Date();","            document.getElementById('last-update').textContent = `Last update: ${lastUpdateTime.toLocaleTimeString()}`;","","            // Update traffic status","            updateTrafficStatus(data.vehicle_count, data.traffic_level);","            ","            // Update gateway list","            updateGatewayList(data.gateway);","            ","            // Update event log","            updateEventLog(data);","            ","            // Update map markers","            updateMapMarkers(data);","        });","","        function updateTrafficStatus(count, level) {","            totalVehicles = count;","            const indicator = document.getElementById('traffic-indicator');","            const levelText = document.getElementById('traffic-level-text');","            ","            // Remove all traffic classes","            indicator.classList.remove('traffic-low', 'traffic-medium', 'traffic-high');","            ","            // Add the appropriate class","            if (level === 'LOW') {","                indicator.classList.add('traffic-low');","                levelText.textContent = 'LOW';","            } else if (level === 'MEDIUM') {","                indicator.classList.add('traffic-medium');","                levelText.textContent = 'MEDIUM';","            } else {","                indicator.classList.add('traffic-high');","                levelText.textContent = 'HEAVY';","            }","            ","            // Update vehicle count display","            document.getElementById('vehicle-count').textContent = ","                `${count} vehicle${count !== 1 ? 's' : ''} detected`;","        }","","        function updateGatewayList(gatewayId) {","            activeGateways.add(gatewayId);","            const gatewayList = document.getElementById('gateway-list');","            gatewayList.innerHTML = '';","            ","            if (activeGateways.size === 0) {","                gatewayList.innerHTML = '<li class=\"list-group-item\">No gateways active</li>';","            } else {","                Array.from(activeGateways).sort().forEach(gateway => {","                    const item = document.createElement('li');","                    item.className = 'list-group-item d-flex justify-content-between align-items-center';","                    item.innerHTML = `","                        ${gateway}","                        <span class=\"badge bg-primary rounded-pill\">Active</span>","                    `;","                    gatewayList.appendChild(item);","                });","            }","        }","","        function updateEventLog(data) {","            const eventLog = document.getElementById('event-log');","            ","            // Create new row","            const row = document.createElement('tr');","            ","            // Determine row class based on traffic level","            if (data.traffic_level === 'HEAVY') {","                row.classList.add('table-danger');","            } else if (data.traffic_level === 'MEDIUM') {","                row.classList.add('table-warning');","            }","            ","            // Format time","            const time = new Date(data.timestamp).toLocaleTimeString();","            ","            // Format location","            const location = `(${data.lat.toFixed(4)}, ${data.lng.toFixed(4)})`;","            ","            // Create cells","            row.innerHTML = `","                <td>${time}</td>","                <td>${data.gateway}</td>","                <td>${location}</td>","                <td>${data.vehicle_count}</td>","                <td>","                    <span class=\"badge ${getTrafficBadgeClass(data.traffic_level)}\">","                        ${data.traffic_level}","                    </span>","                </td>","            `;","            ","            // Insert at the beginning of the table","            if (eventLog.firstChild && eventLog.firstChild.getAttribute('colspan')) {","                eventLog.removeChild(eventLog.firstChild);","            }","            eventLog.insertBefore(row, eventLog.firstChild);","            ","            // Limit to 10 rows","            if (eventLog.children.length > 10) {","                eventLog.removeChild(eventLog.lastChild);","            }","        }","","        function getTrafficBadgeClass(level) {","            switch(level) {","                case 'LOW': return 'bg-success';","                case 'MEDIUM': return 'bg-warning text-dark';","                case 'HEAVY': return 'bg-danger';","                default: return 'bg-secondary';","            }","        }","","        function updateMapMarkers(data) {","            const { lat, lng, vehicle_count, gateway, traffic_level } = data;","            ","            // Update or create vehicle marker","            if (!vehicleMarkers[gateway]) {","                const marker = L.marker([lat, lng], {","                    icon: L.divIcon({","                        className: 'vehicle-marker',","                        html: vehicle_count,","                        iconSize: [20, 20]","                    })","                }).addTo(map);","                ","                marker.bindPopup(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Vehicles:</strong> ${vehicle_count}<br>","                    <strong>Status:</strong> ${traffic_level}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}","                `);","                ","                vehicleMarkers[gateway] = marker;","            } else {","                vehicleMarkers[gateway].setLatLng([lat, lng]);","                vehicleMarkers[gateway]._icon.innerHTML = vehicle_count;","                vehicleMarkers[gateway].setPopupContent(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Vehicles:</strong> ${vehicle_count}<br>","                    <strong>Status:</strong> ${traffic_level}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}","                `);","            }","            ","            // Update or create gateway marker","            if (!gatewayMarkers[gateway]) {","                const marker = L.marker([lat, lng], {","                    icon: L.divIcon({","                        className: 'gateway-marker',","                        html: 'GW',","                        iconSize: [30, 30]","                    })","                }).addTo(map);","                ","                marker.bindPopup(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Last Update:</strong> ${new Date().toLocaleTimeString()}","                `);","                ","                gatewayMarkers[gateway] = marker;","            } else {","                gatewayMarkers[gateway].setLatLng([lat, lng]);","                gatewayMarkers[gateway].setPopupContent(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Last Update:</strong> ${new Date().toLocaleTimeString()}","                `);","            }","            ","            // Center map on this location if it's the first update","            if (Object.keys(vehicleMarkers).length === 1) {","                map.setView([lat, lng], 15);","            }","        }","","        // Initial setup","        document.addEventListener('DOMContentLoaded', () => {","            console.log('Dashboard initialized');","        });","    </script>","</body>","</html>"],"id":38}],[{"start":{"row":0,"column":0},"end":{"row":373,"column":7},"action":"remove","lines":["<!DOCTYPE html>","<html lang=\"en\">","<head>","    <meta charset=\"UTF-8\">","    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">","    <title>LoRaWAN Traffic Dashboard</title>","    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">","    <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\"/>","    <style>","        body {","            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;","            background-color: #f5f5f5;","        }","        .dashboard-header {","            background-color: #2c3e50;","            color: white;","            padding: 20px 0;","            margin-bottom: 30px;","        }","        .card {","            box-shadow: 0 4px 8px rgba(0,0,0,0.1);","            margin-bottom: 20px;","            border: none;","        }","        .card-header {","            background-color: #3498db;","            color: white;","            font-weight: bold;","        }","        #map {","            height: 500px;","            border-radius: 4px;","        }","        .traffic-indicator {","            font-size: 24px;","            font-weight: bold;","            padding: 10px;","            border-radius: 4px;","            text-align: center;","            margin-bottom: 15px;","        }","        .traffic-low {","            background-color: #2ecc71;","            color: white;","        }","        .traffic-medium {","            background-color: #f39c12;","            color: white;","        }","        .traffic-high {","            background-color: #e74c3c;","            color: white;","        }","        .vehicle-marker {","            background-color: rgba(231, 76, 60, 0.8);","            border-radius: 50%;","            width: 20px;","            height: 20px;","            display: flex;","            justify-content: center;","            align-items: center;","            color: white;","            font-weight: bold;","            font-size: 12px;","        }","        .gateway-marker {","            background-color: rgba(52, 152, 219, 0.8);","            border-radius: 50%;","            width: 30px;","            height: 30px;","            display: flex;","            justify-content: center;","            align-items: center;","            color: white;","            font-weight: bold;","            font-size: 12px;","        }","        #connection-status {","            position: absolute;","            top: 20px;","            right: 20px;","            font-size: 14px;","        }","        .last-update {","            font-size: 12px;","            color: #7f8c8d;","            text-align: right;","            margin-top: 5px;","        }","    </style>","</head>","<body>","    <div class=\"dashboard-header\">","        <div class=\"container position-relative\">","            <h1>LoRaWAN Traffic Monitoring</h1>","            <p>Real-time vehicle tracking from gateways</p>","            <div id=\"connection-status\" class=\"badge bg-secondary\">Connecting...</div>","        </div>","    </div>","","    <div class=\"container\">","        <div class=\"row\">","            <div class=\"col-md-8\">","                <div class=\"card\">","                    <div class=\"card-header\">Traffic Map</div>","                    <div class=\"card-body\">","                        <div id=\"map\"></div>","                        <div class=\"last-update\" id=\"last-update\">No updates yet</div>","                    </div>","                </div>","            </div>","            <div class=\"col-md-4\">","                <div class=\"card\">","                    <div class=\"card-header\">Traffic Status</div>","                    <div class=\"card-body\">","                        <div id=\"traffic-indicator\" class=\"traffic-low traffic-indicator\">","                            <span id=\"traffic-level-text\">LOW</span> TRAFFIC","                        </div>","                        <div id=\"vehicle-count\" class=\"h4 text-center\">0 vehicles detected</div>","                        <div class=\"mt-3\">","                            <h5>Active Gateways</h5>","                            <ul id=\"gateway-list\" class=\"list-group\">","                                <li class=\"list-group-item\">No gateways active</li>","                            </ul>","                        </div>","                    </div>","                </div>","            </div>","        </div>","","        <div class=\"row mt-4\">","            <div class=\"col-12\">","                <div class=\"card\">","                    <div class=\"card-header\">Recent Traffic Events</div>","                    <div class=\"card-body\">","                        <table class=\"table table-striped\">","                            <thead>","                                <tr>","                                    <th>Time</th>","                                    <th>Gateway</th>","                                    <th>Location</th>","                                    <th>Vehicle Count</th>","                                    <th>Status</th>","                                </tr>","                            </thead>","                            <tbody id=\"event-log\">","                                <tr>","                                    <td colspan=\"5\" class=\"text-center\">Waiting for data...</td>","                                </tr>","                            </tbody>","                        </table>","                    </div>","                </div>","            </div>","        </div>","    </div>","","    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>","    <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>","    <script src=\"https://cdn.socket.io/4.7.4/socket.io.min.js\"></script>","    <script>","        // Initialize map","        const map = L.map('map').setView([0, 0], 2);","        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {","            attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'","        }).addTo(map);","","        // Store markers and data","        const vehicleMarkers = {};","        const gatewayMarkers = {};","        let lastUpdateTime = null;","        let totalVehicles = 0;","        let activeGateways = new Set();","","        // Connect to Socket.IO server","        const socket = io();","        ","        socket.on('connect', () => {","            console.log('Connected to fog handler');","            document.getElementById('connection-status').className = 'badge bg-success';","            document.getElementById('connection-status').textContent = 'Connected';","        });","","        socket.on('disconnect', () => {","            console.log('Disconnected from fog handler');","            document.getElementById('connection-status').className = 'badge bg-danger';","            document.getElementById('connection-status').textContent = 'Disconnected';","        });","","        socket.on('update', (data) => {","            // Update last update time","            lastUpdateTime = new Date();","            document.getElementById('last-update').textContent = `Last update: ${lastUpdateTime.toLocaleTimeString()}`;","","            // Update traffic status","            updateTrafficStatus(data.vehicle_count, data.traffic_level);","            ","            // Update gateway list","            updateGatewayList(data.gateway);","            ","            // Update event log","            updateEventLog(data);","            ","            // Update map markers","            updateMapMarkers(data);","        });","","        function updateTrafficStatus(count, level) {","            totalVehicles = count;","            const indicator = document.getElementById('traffic-indicator');","            const levelText = document.getElementById('traffic-level-text');","            ","            // Remove all traffic classes","            indicator.classList.remove('traffic-low', 'traffic-medium', 'traffic-high');","            ","            // Add the appropriate class","            if (level === 'LOW') {","                indicator.classList.add('traffic-low');","                levelText.textContent = 'LOW';","            } else if (level === 'MEDIUM') {","                indicator.classList.add('traffic-medium');","                levelText.textContent = 'MEDIUM';","            } else {","                indicator.classList.add('traffic-high');","                levelText.textContent = 'HEAVY';","            }","            ","            // Update vehicle count display","            document.getElementById('vehicle-count').textContent = ","                `${count} vehicle${count !== 1 ? 's' : ''} detected`;","        }","","        function updateGatewayList(gatewayId) {","            activeGateways.add(gatewayId);","            const gatewayList = document.getElementById('gateway-list');","            gatewayList.innerHTML = '';","            ","            if (activeGateways.size === 0) {","                gatewayList.innerHTML = '<li class=\"list-group-item\">No gateways active</li>';","            } else {","                Array.from(activeGateways).sort().forEach(gateway => {","                    const item = document.createElement('li');","                    item.className = 'list-group-item d-flex justify-content-between align-items-center';","                    item.innerHTML = `","                        ${gateway}","                        <span class=\"badge bg-primary rounded-pill\">Active</span>","                    `;","                    gatewayList.appendChild(item);","                });","            }","        }","","        function updateEventLog(data) {","            const eventLog = document.getElementById('event-log');","            ","            // Create new row","            const row = document.createElement('tr');","            ","            // Determine row class based on traffic level","            if (data.traffic_level === 'HEAVY') {","                row.classList.add('table-danger');","            } else if (data.traffic_level === 'MEDIUM') {","                row.classList.add('table-warning');","            }","            ","            // Format time","            const time = new Date(data.timestamp).toLocaleTimeString();","            ","            // Format location","            const location = `(${data.lat.toFixed(4)}, ${data.lng.toFixed(4)})`;","            ","            // Create cells","            row.innerHTML = `","                <td>${time}</td>","                <td>${data.gateway}</td>","                <td>${location}</td>","                <td>${data.vehicle_count}</td>","                <td>","                    <span class=\"badge ${getTrafficBadgeClass(data.traffic_level)}\">","                        ${data.traffic_level}","                    </span>","                </td>","            `;","            ","            // Insert at the beginning of the table","            if (eventLog.firstChild && eventLog.firstChild.getAttribute('colspan')) {","                eventLog.removeChild(eventLog.firstChild);","            }","            eventLog.insertBefore(row, eventLog.firstChild);","            ","            // Limit to 10 rows","            if (eventLog.children.length > 10) {","                eventLog.removeChild(eventLog.lastChild);","            }","        }","","        function getTrafficBadgeClass(level) {","            switch(level) {","                case 'LOW': return 'bg-success';","                case 'MEDIUM': return 'bg-warning text-dark';","                case 'HEAVY': return 'bg-danger';","                default: return 'bg-secondary';","            }","        }","","        function updateMapMarkers(data) {","            const { lat, lng, vehicle_count, gateway, traffic_level } = data;","            ","            // Update or create vehicle marker","            if (!vehicleMarkers[gateway]) {","                const marker = L.marker([lat, lng], {","                    icon: L.divIcon({","                        className: 'vehicle-marker',","                        html: vehicle_count,","                        iconSize: [20, 20]","                    })","                }).addTo(map);","                ","                marker.bindPopup(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Vehicles:</strong> ${vehicle_count}<br>","                    <strong>Status:</strong> ${traffic_level}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}","                `);","                ","                vehicleMarkers[gateway] = marker;","            } else {","                vehicleMarkers[gateway].setLatLng([lat, lng]);","                vehicleMarkers[gateway]._icon.innerHTML = vehicle_count;","                vehicleMarkers[gateway].setPopupContent(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Vehicles:</strong> ${vehicle_count}<br>","                    <strong>Status:</strong> ${traffic_level}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}","                `);","            }","            ","            // Update or create gateway marker","            if (!gatewayMarkers[gateway]) {","                const marker = L.marker([lat, lng], {","                    icon: L.divIcon({","                        className: 'gateway-marker',","                        html: 'GW',","                        iconSize: [30, 30]","                    })","                }).addTo(map);","                ","                marker.bindPopup(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Last Update:</strong> ${new Date().toLocaleTimeString()}","                `);","                ","                gatewayMarkers[gateway] = marker;","            } else {","                gatewayMarkers[gateway].setLatLng([lat, lng]);","                gatewayMarkers[gateway].setPopupContent(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Last Update:</strong> ${new Date().toLocaleTimeString()}","                `);","            }","            ","            // Center map on this location if it's the first update","            if (Object.keys(vehicleMarkers).length === 1) {","                map.setView([lat, lng], 15);","            }","        }","","        // Initial setup","        document.addEventListener('DOMContentLoaded', () => {","            console.log('Dashboard initialized');","        });","    </script>","</body>","</html>"],"id":39}],[{"start":{"row":0,"column":0},"end":{"row":382,"column":7},"action":"insert","lines":["<!DOCTYPE html>","<html lang=\"en\">","<head>","    <meta charset=\"UTF-8\">","    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">","    <title>LoRaWAN Traffic Dashboard</title>","    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">","    <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\"/>","    <style>","        body {","            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;","            background-color: #f5f5f5;","        }","        .dashboard-header {","            background-color: #2c3e50;","            color: white;","            padding: 20px 0;","            margin-bottom: 30px;","        }","        .card {","            box-shadow: 0 4px 8px rgba(0,0,0,0.1);","            margin-bottom: 20px;","            border: none;","        }","        .card-header {","            background-color: #3498db;","            color: white;","            font-weight: bold;","        }","        #map {","            height: 500px;","            border-radius: 4px;","        }","        .traffic-indicator {","            font-size: 24px;","            font-weight: bold;","            padding: 10px;","            border-radius: 4px;","            text-align: center;","            margin-bottom: 15px;","        }","        .traffic-low {","            background-color: #2ecc71;","            color: white;","        }","        .traffic-medium {","            background-color: #f39c12;","            color: white;","        }","        .traffic-high {","            background-color: #e74c3c;","            color: white;","        }","        .vehicle-marker {","            background-color: rgba(231, 76, 60, 0.8);","            border-radius: 50%;","            width: 20px;","            height: 20px;","            display: flex;","            justify-content: center;","            align-items: center;","            color: white;","            font-weight: bold;","            font-size: 12px;","        }","        .gateway-marker {","            background-color: rgba(52, 152, 219, 0.8);","            border-radius: 50%;","            width: 30px;","            height: 30px;","            display: flex;","            justify-content: center;","            align-items: center;","            color: white;","            font-weight: bold;","            font-size: 12px;","        }","        #connection-status {","            position: absolute;","            top: 20px;","            right: 20px;","            font-size: 14px;","        }","        .last-update {","            font-size: 12px;","            color: #7f8c8d;","            text-align: right;","            margin-top: 5px;","        }","    </style>","</head>","<body>","    <div class=\"dashboard-header\">","        <div class=\"container position-relative\">","            <h1>LoRaWAN Traffic Monitoring</h1>","            <p>Real-time vehicle tracking from gateways</p>","            <div id=\"connection-status\" class=\"badge bg-secondary\">Connecting...</div>","        </div>","    </div>","","    <div class=\"container\">","        <div class=\"row\">","            <div class=\"col-md-8\">","                <div class=\"card\">","                    <div class=\"card-header\">Traffic Map</div>","                    <div class=\"card-body\">","                        <div id=\"map\"></div>","                        <div class=\"last-update\" id=\"last-update\">No updates yet</div>","                    </div>","                </div>","            </div>","            <div class=\"col-md-4\">","                <div class=\"card\">","                    <div class=\"card-header\">Traffic Status</div>","                    <div class=\"card-body\">","                        <div id=\"traffic-indicator\" class=\"traffic-low traffic-indicator\">","                            <span id=\"traffic-level-text\">LOW</span> TRAFFIC","                        </div>","                        <div id=\"vehicle-count\" class=\"h4 text-center\">0 vehicles detected</div>","                        <div class=\"mt-3\">","                            <h5>Active Gateways</h5>","                            <ul id=\"gateway-list\" class=\"list-group\">","                                <li class=\"list-group-item\">No gateways active</li>","                            </ul>","                        </div>","                    </div>","                </div>","            </div>","        </div>","","        <div class=\"row mt-4\">","            <div class=\"col-12\">","                <div class=\"card\">","                    <div class=\"card-header\">Recent Traffic Events</div>","                    <div class=\"card-body\">","                        <table class=\"table table-striped\">","                            <thead>","                                <tr>","                                    <th>Time</th>","                                    <th>Gateway</th>","                                    <th>Location</th>","                                    <th>Vehicle Count</th>","                                    <th>Status</th>","                                </tr>","                            </thead>","                            <tbody id=\"event-log\">","                                <tr>","                                    <td colspan=\"5\" class=\"text-center\">Waiting for data...</td>","                                </tr>","                            </tbody>","                        </table>","                    </div>","                </div>","            </div>","        </div>","    </div>","","    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>","    <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>","    <script src=\"https://cdn.socket.io/4.7.4/socket.io.min.js\"></script>","    <script>","        // Initialize map","        const map = L.map('map').setView([0, 0], 2);","        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {","            attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'","        }).addTo(map);","","        // Store markers and data","        const vehicleMarkers = {};","        const gatewayMarkers = {};","        let lastUpdateTime = null;","        let totalVehicles = 0;","        let activeGateways = new Set();","","        // Connect to Socket.IO server","        const socket = io();","        ","        socket.on('connect', () => {","            console.log('Connected to fog handler');","            document.getElementById('connection-status').className = 'badge bg-success';","            document.getElementById('connection-status').textContent = 'Connected';","        });","","        socket.on('disconnect', () => {","            console.log('Disconnected from fog handler');","            document.getElementById('connection-status').className = 'badge bg-danger';","            document.getElementById('connection-status').textContent = 'Disconnected';","        });","","        socket.on('update', (data) => {","            console.log('Received update:', data);","            ","            // Update last update time","            lastUpdateTime = new Date();","            document.getElementById('last-update').textContent = `Last update: ${lastUpdateTime.toLocaleTimeString()}`;","","            // Update traffic status","            updateTrafficStatus(data.vehicle_count, data.traffic_level);","            ","            // Update gateway list","            updateGatewayList(data.gateway);","            ","            // Update event log","            updateEventLog(data);","            ","            // Update map markers","            updateMapMarkers(data);","        });","","        function updateTrafficStatus(count, level) {","            totalVehicles = count;","            const indicator = document.getElementById('traffic-indicator');","            const levelText = document.getElementById('traffic-level-text');","            ","            // Remove all traffic classes","            indicator.classList.remove('traffic-low', 'traffic-medium', 'traffic-high');","            ","            // Add the appropriate class","            if (level === 'LOW') {","                indicator.classList.add('traffic-low');","                levelText.textContent = 'LOW';","            } else if (level === 'MEDIUM') {","                indicator.classList.add('traffic-medium');","                levelText.textContent = 'MEDIUM';","            } else {","                indicator.classList.add('traffic-high');","                levelText.textContent = 'HEAVY';","            }","            ","            // Update vehicle count display","            document.getElementById('vehicle-count').textContent = ","                `${count} vehicle${count !== 1 ? 's' : ''} detected`;","        }","","        function updateGatewayList(gatewayId) {","            activeGateways.add(gatewayId);","            const gatewayList = document.getElementById('gateway-list');","            gatewayList.innerHTML = '';","            ","            if (activeGateways.size === 0) {","                gatewayList.innerHTML = '<li class=\"list-group-item\">No gateways active</li>';","            } else {","                Array.from(activeGateways).sort().forEach(gateway => {","                    const item = document.createElement('li');","                    item.className = 'list-group-item d-flex justify-content-between align-items-center';","                    item.innerHTML = `","                        ${gateway}","                        <span class=\"badge bg-primary rounded-pill\">Active</span>","                    `;","                    gatewayList.appendChild(item);","                });","            }","        }","","        function updateEventLog(data) {","            const eventLog = document.getElementById('event-log');","            ","            // Create new row","            const row = document.createElement('tr');","            ","            // Determine row class based on traffic level","            if (data.traffic_level === 'HEAVY') {","                row.classList.add('table-danger');","            } else if (data.traffic_level === 'MEDIUM') {","                row.classList.add('table-warning');","            }","            ","            // Format time","            const timestamp = data.timestamp || new Date().toISOString();","            const time = new Date(timestamp).toLocaleTimeString();","            ","            // Format location","            const location = `(${data.lat.toFixed(4)}, ${data.lng.toFixed(4)})`;","            ","            // Create cells","            row.innerHTML = `","                <td>${time}</td>","                <td>${data.gateway}</td>","                <td>${location}</td>","                <td>${data.vehicle_count}</td>","                <td>","                    <span class=\"badge ${getTrafficBadgeClass(data.traffic_level)}\">","                        ${data.traffic_level}","                    </span>","                </td>","            `;","            ","            // Insert at the beginning of the table","            if (eventLog.firstChild && eventLog.firstChild.getAttribute('colspan')) {","                eventLog.removeChild(eventLog.firstChild);","            }","            eventLog.insertBefore(row, eventLog.firstChild);","            ","            // Limit to 10 rows","            if (eventLog.children.length > 10) {","                eventLog.removeChild(eventLog.lastChild);","            }","        }","","        function getTrafficBadgeClass(level) {","            switch(level) {","                case 'LOW': return 'bg-success';","                case 'MEDIUM': return 'bg-warning text-dark';","                case 'HEAVY': return 'bg-danger';","                default: return 'bg-secondary';","            }","        }","","        function updateMapMarkers(data) {","            const lat = data.lat;","            const lng = data.lng;","            const vehicle_count = data.vehicle_count;","            const gateway = data.gateway || 'unknown';","            const traffic_level = data.traffic_level || 'LOW';","            ","            // Update or create vehicle marker","            if (!vehicleMarkers[gateway]) {","                const marker = L.marker([lat, lng], {","                    icon: L.divIcon({","                        className: 'vehicle-marker',","                        html: vehicle_count,","                        iconSize: [20, 20]","                    })","                }).addTo(map);","                ","                marker.bindPopup(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Vehicles:</strong> ${vehicle_count}<br>","                    <strong>Status:</strong> ${traffic_level}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}<br>","                    <strong>Time:</strong> ${new Date(data.timestamp).toLocaleTimeString()}","                `);","                ","                vehicleMarkers[gateway] = marker;","            } else {","                vehicleMarkers[gateway].setLatLng([lat, lng]);","                vehicleMarkers[gateway]._icon.innerHTML = vehicle_count;","                vehicleMarkers[gateway].setPopupContent(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Vehicles:</strong> ${vehicle_count}<br>","                    <strong>Status:</strong> ${traffic_level}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}<br>","                    <strong>Time:</strong> ${new Date(data.timestamp).toLocaleTimeString()}","                `);","            }","            ","            // Update or create gateway marker","            if (!gatewayMarkers[gateway]) {","                const marker = L.marker([lat, lng], {","                    icon: L.divIcon({","                        className: 'gateway-marker',","                        html: 'GW',","                        iconSize: [30, 30]","                    })","                }).addTo(map);","                ","                marker.bindPopup(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Last Update:</strong> ${new Date(data.timestamp).toLocaleTimeString()}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}","                `);","                ","                gatewayMarkers[gateway] = marker;","            } else {","                gatewayMarkers[gateway].setLatLng([lat, lng]);","                gatewayMarkers[gateway].setPopupContent(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Last Update:</strong> ${new Date(data.timestamp).toLocaleTimeString()}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}","                `);","            }","            ","            // Center map on this location with appropriate zoom","            map.setView([lat, lng], 15);","        }","","        // Initial setup","        document.addEventListener('DOMContentLoaded', () => {","            console.log('Dashboard initialized');","        });","    </script>","</body>","</html>"],"id":40}],[{"start":{"row":190,"column":12},"end":{"row":190,"column":50},"action":"remove","lines":["console.log('Received update:', data);"],"id":41},{"start":{"row":190,"column":12},"end":{"row":190,"column":50},"action":"insert","lines":["console.log('Raw update data:', data);"]}],[{"start":{"row":255,"column":12},"end":{"row":297,"column":9},"action":"remove","lines":["const eventLog = document.getElementById('event-log');","            ","            // Create new row","            const row = document.createElement('tr');","            ","            // Determine row class based on traffic level","            if (data.traffic_level === 'HEAVY') {","                row.classList.add('table-danger');","            } else if (data.traffic_level === 'MEDIUM') {","                row.classList.add('table-warning');","            }","            ","            // Format time","            const timestamp = data.timestamp || new Date().toISOString();","            const time = new Date(timestamp).toLocaleTimeString();","            ","            // Format location","            const location = `(${data.lat.toFixed(4)}, ${data.lng.toFixed(4)})`;","            ","            // Create cells","            row.innerHTML = `","                <td>${time}</td>","                <td>${data.gateway}</td>","                <td>${location}</td>","                <td>${data.vehicle_count}</td>","                <td>","                    <span class=\"badge ${getTrafficBadgeClass(data.traffic_level)}\">","                        ${data.traffic_level}","                    </span>","                </td>","            `;","            ","            // Insert at the beginning of the table","            if (eventLog.firstChild && eventLog.firstChild.getAttribute('colspan')) {","                eventLog.removeChild(eventLog.firstChild);","            }","            eventLog.insertBefore(row, eventLog.firstChild);","            ","            // Limit to 10 rows","            if (eventLog.children.length > 10) {","                eventLog.removeChild(eventLog.lastChild);","            }","        }"],"id":42},{"start":{"row":255,"column":12},"end":{"row":298,"column":1},"action":"insert","lines":["const eventLog = document.getElementById('event-log');","    ","    // First, ensure we remove the \"Waiting for data...\" row if it exists","    if (eventLog.firstChild && eventLog.firstChild.getAttribute('colspan')) {","        eventLog.removeChild(eventLog.firstChild);","    }","","    // Create new row","    const row = document.createElement('tr');","    ","    // Add appropriate class based on traffic level","    if (data.traffic_level === 'HEAVY') row.classList.add('table-danger');","    else if (data.traffic_level === 'MEDIUM') row.classList.add('table-warning');","","    // Parse timestamp - handle both ISO format and your custom format","    let timestamp;","    try {","        timestamp = new Date(data.timestamp);","        if (isNaN(timestamp.getTime())) {","            // Fallback for non-ISO formats","            timestamp = new Date(data.timestamp.replace(' ', 'T') + 'Z');","        }","    } catch (e) {","        console.error('Error parsing timestamp:', e);","        timestamp = new Date(); // Fallback to current time","    }","","    // Create cells","    row.innerHTML = `","        <td>${timestamp.toLocaleTimeString()}</td>","        <td>${data.gateway || 'unknown'}</td>","        <td>(${data.lat.toFixed(4)}, ${data.lng.toFixed(4)})</td>","        <td>${data.vehicle_count}</td>","        <td><span class=\"badge ${getTrafficBadgeClass(data.traffic_level)}\">${data.traffic_level}</span></td>","    `;","    ","    // Insert new row at top","    eventLog.insertBefore(row, eventLog.firstChild);","    ","    // Limit to 10 rows","    while (eventLog.children.length > 10) {","        eventLog.removeChild(eventLog.lastChild);","    }","}"]}],[{"start":{"row":0,"column":0},"end":{"row":383,"column":7},"action":"remove","lines":["<!DOCTYPE html>","<html lang=\"en\">","<head>","    <meta charset=\"UTF-8\">","    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">","    <title>LoRaWAN Traffic Dashboard</title>","    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">","    <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\"/>","    <style>","        body {","            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;","            background-color: #f5f5f5;","        }","        .dashboard-header {","            background-color: #2c3e50;","            color: white;","            padding: 20px 0;","            margin-bottom: 30px;","        }","        .card {","            box-shadow: 0 4px 8px rgba(0,0,0,0.1);","            margin-bottom: 20px;","            border: none;","        }","        .card-header {","            background-color: #3498db;","            color: white;","            font-weight: bold;","        }","        #map {","            height: 500px;","            border-radius: 4px;","        }","        .traffic-indicator {","            font-size: 24px;","            font-weight: bold;","            padding: 10px;","            border-radius: 4px;","            text-align: center;","            margin-bottom: 15px;","        }","        .traffic-low {","            background-color: #2ecc71;","            color: white;","        }","        .traffic-medium {","            background-color: #f39c12;","            color: white;","        }","        .traffic-high {","            background-color: #e74c3c;","            color: white;","        }","        .vehicle-marker {","            background-color: rgba(231, 76, 60, 0.8);","            border-radius: 50%;","            width: 20px;","            height: 20px;","            display: flex;","            justify-content: center;","            align-items: center;","            color: white;","            font-weight: bold;","            font-size: 12px;","        }","        .gateway-marker {","            background-color: rgba(52, 152, 219, 0.8);","            border-radius: 50%;","            width: 30px;","            height: 30px;","            display: flex;","            justify-content: center;","            align-items: center;","            color: white;","            font-weight: bold;","            font-size: 12px;","        }","        #connection-status {","            position: absolute;","            top: 20px;","            right: 20px;","            font-size: 14px;","        }","        .last-update {","            font-size: 12px;","            color: #7f8c8d;","            text-align: right;","            margin-top: 5px;","        }","    </style>","</head>","<body>","    <div class=\"dashboard-header\">","        <div class=\"container position-relative\">","            <h1>LoRaWAN Traffic Monitoring</h1>","            <p>Real-time vehicle tracking from gateways</p>","            <div id=\"connection-status\" class=\"badge bg-secondary\">Connecting...</div>","        </div>","    </div>","","    <div class=\"container\">","        <div class=\"row\">","            <div class=\"col-md-8\">","                <div class=\"card\">","                    <div class=\"card-header\">Traffic Map</div>","                    <div class=\"card-body\">","                        <div id=\"map\"></div>","                        <div class=\"last-update\" id=\"last-update\">No updates yet</div>","                    </div>","                </div>","            </div>","            <div class=\"col-md-4\">","                <div class=\"card\">","                    <div class=\"card-header\">Traffic Status</div>","                    <div class=\"card-body\">","                        <div id=\"traffic-indicator\" class=\"traffic-low traffic-indicator\">","                            <span id=\"traffic-level-text\">LOW</span> TRAFFIC","                        </div>","                        <div id=\"vehicle-count\" class=\"h4 text-center\">0 vehicles detected</div>","                        <div class=\"mt-3\">","                            <h5>Active Gateways</h5>","                            <ul id=\"gateway-list\" class=\"list-group\">","                                <li class=\"list-group-item\">No gateways active</li>","                            </ul>","                        </div>","                    </div>","                </div>","            </div>","        </div>","","        <div class=\"row mt-4\">","            <div class=\"col-12\">","                <div class=\"card\">","                    <div class=\"card-header\">Recent Traffic Events</div>","                    <div class=\"card-body\">","                        <table class=\"table table-striped\">","                            <thead>","                                <tr>","                                    <th>Time</th>","                                    <th>Gateway</th>","                                    <th>Location</th>","                                    <th>Vehicle Count</th>","                                    <th>Status</th>","                                </tr>","                            </thead>","                            <tbody id=\"event-log\">","                                <tr>","                                    <td colspan=\"5\" class=\"text-center\">Waiting for data...</td>","                                </tr>","                            </tbody>","                        </table>","                    </div>","                </div>","            </div>","        </div>","    </div>","","    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>","    <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>","    <script src=\"https://cdn.socket.io/4.7.4/socket.io.min.js\"></script>","    <script>","        // Initialize map","        const map = L.map('map').setView([0, 0], 2);","        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {","            attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'","        }).addTo(map);","","        // Store markers and data","        const vehicleMarkers = {};","        const gatewayMarkers = {};","        let lastUpdateTime = null;","        let totalVehicles = 0;","        let activeGateways = new Set();","","        // Connect to Socket.IO server","        const socket = io();","        ","        socket.on('connect', () => {","            console.log('Connected to fog handler');","            document.getElementById('connection-status').className = 'badge bg-success';","            document.getElementById('connection-status').textContent = 'Connected';","        });","","        socket.on('disconnect', () => {","            console.log('Disconnected from fog handler');","            document.getElementById('connection-status').className = 'badge bg-danger';","            document.getElementById('connection-status').textContent = 'Disconnected';","        });","","        socket.on('update', (data) => {","            console.log('Raw update data:', data);","            ","            // Update last update time","            lastUpdateTime = new Date();","            document.getElementById('last-update').textContent = `Last update: ${lastUpdateTime.toLocaleTimeString()}`;","","            // Update traffic status","            updateTrafficStatus(data.vehicle_count, data.traffic_level);","            ","            // Update gateway list","            updateGatewayList(data.gateway);","            ","            // Update event log","            updateEventLog(data);","            ","            // Update map markers","            updateMapMarkers(data);","        });","","        function updateTrafficStatus(count, level) {","            totalVehicles = count;","            const indicator = document.getElementById('traffic-indicator');","            const levelText = document.getElementById('traffic-level-text');","            ","            // Remove all traffic classes","            indicator.classList.remove('traffic-low', 'traffic-medium', 'traffic-high');","            ","            // Add the appropriate class","            if (level === 'LOW') {","                indicator.classList.add('traffic-low');","                levelText.textContent = 'LOW';","            } else if (level === 'MEDIUM') {","                indicator.classList.add('traffic-medium');","                levelText.textContent = 'MEDIUM';","            } else {","                indicator.classList.add('traffic-high');","                levelText.textContent = 'HEAVY';","            }","            ","            // Update vehicle count display","            document.getElementById('vehicle-count').textContent = ","                `${count} vehicle${count !== 1 ? 's' : ''} detected`;","        }","","        function updateGatewayList(gatewayId) {","            activeGateways.add(gatewayId);","            const gatewayList = document.getElementById('gateway-list');","            gatewayList.innerHTML = '';","            ","            if (activeGateways.size === 0) {","                gatewayList.innerHTML = '<li class=\"list-group-item\">No gateways active</li>';","            } else {","                Array.from(activeGateways).sort().forEach(gateway => {","                    const item = document.createElement('li');","                    item.className = 'list-group-item d-flex justify-content-between align-items-center';","                    item.innerHTML = `","                        ${gateway}","                        <span class=\"badge bg-primary rounded-pill\">Active</span>","                    `;","                    gatewayList.appendChild(item);","                });","            }","        }","","        function updateEventLog(data) {","            const eventLog = document.getElementById('event-log');","    ","    // First, ensure we remove the \"Waiting for data...\" row if it exists","    if (eventLog.firstChild && eventLog.firstChild.getAttribute('colspan')) {","        eventLog.removeChild(eventLog.firstChild);","    }","","    // Create new row","    const row = document.createElement('tr');","    ","    // Add appropriate class based on traffic level","    if (data.traffic_level === 'HEAVY') row.classList.add('table-danger');","    else if (data.traffic_level === 'MEDIUM') row.classList.add('table-warning');","","    // Parse timestamp - handle both ISO format and your custom format","    let timestamp;","    try {","        timestamp = new Date(data.timestamp);","        if (isNaN(timestamp.getTime())) {","            // Fallback for non-ISO formats","            timestamp = new Date(data.timestamp.replace(' ', 'T') + 'Z');","        }","    } catch (e) {","        console.error('Error parsing timestamp:', e);","        timestamp = new Date(); // Fallback to current time","    }","","    // Create cells","    row.innerHTML = `","        <td>${timestamp.toLocaleTimeString()}</td>","        <td>${data.gateway || 'unknown'}</td>","        <td>(${data.lat.toFixed(4)}, ${data.lng.toFixed(4)})</td>","        <td>${data.vehicle_count}</td>","        <td><span class=\"badge ${getTrafficBadgeClass(data.traffic_level)}\">${data.traffic_level}</span></td>","    `;","    ","    // Insert new row at top","    eventLog.insertBefore(row, eventLog.firstChild);","    ","    // Limit to 10 rows","    while (eventLog.children.length > 10) {","        eventLog.removeChild(eventLog.lastChild);","    }","}","","        function getTrafficBadgeClass(level) {","            switch(level) {","                case 'LOW': return 'bg-success';","                case 'MEDIUM': return 'bg-warning text-dark';","                case 'HEAVY': return 'bg-danger';","                default: return 'bg-secondary';","            }","        }","","        function updateMapMarkers(data) {","            const lat = data.lat;","            const lng = data.lng;","            const vehicle_count = data.vehicle_count;","            const gateway = data.gateway || 'unknown';","            const traffic_level = data.traffic_level || 'LOW';","            ","            // Update or create vehicle marker","            if (!vehicleMarkers[gateway]) {","                const marker = L.marker([lat, lng], {","                    icon: L.divIcon({","                        className: 'vehicle-marker',","                        html: vehicle_count,","                        iconSize: [20, 20]","                    })","                }).addTo(map);","                ","                marker.bindPopup(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Vehicles:</strong> ${vehicle_count}<br>","                    <strong>Status:</strong> ${traffic_level}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}<br>","                    <strong>Time:</strong> ${new Date(data.timestamp).toLocaleTimeString()}","                `);","                ","                vehicleMarkers[gateway] = marker;","            } else {","                vehicleMarkers[gateway].setLatLng([lat, lng]);","                vehicleMarkers[gateway]._icon.innerHTML = vehicle_count;","                vehicleMarkers[gateway].setPopupContent(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Vehicles:</strong> ${vehicle_count}<br>","                    <strong>Status:</strong> ${traffic_level}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}<br>","                    <strong>Time:</strong> ${new Date(data.timestamp).toLocaleTimeString()}","                `);","            }","            ","            // Update or create gateway marker","            if (!gatewayMarkers[gateway]) {","                const marker = L.marker([lat, lng], {","                    icon: L.divIcon({","                        className: 'gateway-marker',","                        html: 'GW',","                        iconSize: [30, 30]","                    })","                }).addTo(map);","                ","                marker.bindPopup(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Last Update:</strong> ${new Date(data.timestamp).toLocaleTimeString()}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}","                `);","                ","                gatewayMarkers[gateway] = marker;","            } else {","                gatewayMarkers[gateway].setLatLng([lat, lng]);","                gatewayMarkers[gateway].setPopupContent(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Last Update:</strong> ${new Date(data.timestamp).toLocaleTimeString()}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}","                `);","            }","            ","            // Center map on this location with appropriate zoom","            map.setView([lat, lng], 15);","        }","","        // Initial setup","        document.addEventListener('DOMContentLoaded', () => {","            console.log('Dashboard initialized');","        });","    </script>","</body>","</html>"],"id":43}],[{"start":{"row":0,"column":0},"end":{"row":413,"column":7},"action":"insert","lines":["<!DOCTYPE html>","<html lang=\"en\">","<head>","    <meta charset=\"UTF-8\">","    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">","    <title>LoRaWAN Traffic Dashboard</title>","    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">","    <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\"/>","    <style>","        body {","            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;","            background-color: #f5f5f5;","        }","        .dashboard-header {","            background-color: #2c3e50;","            color: white;","            padding: 20px 0;","            margin-bottom: 30px;","        }","        .card {","            box-shadow: 0 4px 8px rgba(0,0,0,0.1);","            margin-bottom: 20px;","            border: none;","        }","        .card-header {","            background-color: #3498db;","            color: white;","            font-weight: bold;","        }","        #map {","            height: 500px;","            border-radius: 4px;","        }","        .traffic-indicator {","            font-size: 24px;","            font-weight: bold;","            padding: 10px;","            border-radius: 4px;","            text-align: center;","            margin-bottom: 15px;","        }","        .traffic-low {","            background-color: #2ecc71;","            color: white;","        }","        .traffic-medium {","            background-color: #f39c12;","            color: white;","        }","        .traffic-high {","            background-color: #e74c3c;","            color: white;","        }","        .vehicle-marker {","            background-color: rgba(231, 76, 60, 0.8);","            border-radius: 50%;","            width: 20px;","            height: 20px;","            display: flex;","            justify-content: center;","            align-items: center;","            color: white;","            font-weight: bold;","            font-size: 12px;","        }","        .gateway-marker {","            background-color: rgba(52, 152, 219, 0.8);","            border-radius: 50%;","            width: 30px;","            height: 30px;","            display: flex;","            justify-content: center;","            align-items: center;","            color: white;","            font-weight: bold;","            font-size: 12px;","        }","        #connection-status {","            position: absolute;","            top: 20px;","            right: 20px;","            font-size: 14px;","        }","        .last-update {","            font-size: 12px;","            color: #7f8c8d;","            text-align: right;","            margin-top: 5px;","        }","    </style>","</head>","<body>","    <div class=\"dashboard-header\">","        <div class=\"container position-relative\">","            <h1>LoRaWAN Traffic Monitoring</h1>","            <p>Real-time vehicle tracking from gateways</p>","            <div id=\"connection-status\" class=\"badge bg-secondary\">Connecting...</div>","        </div>","    </div>","","    <div class=\"container\">","        <div class=\"row\">","            <div class=\"col-md-8\">","                <div class=\"card\">","                    <div class=\"card-header\">Traffic Map</div>","                    <div class=\"card-body\">","                        <div id=\"map\"></div>","                        <div class=\"last-update\" id=\"last-update\">No updates yet</div>","                    </div>","                </div>","            </div>","            <div class=\"col-md-4\">","                <div class=\"card\">","                    <div class=\"card-header\">Traffic Status</div>","                    <div class=\"card-body\">","                        <div id=\"traffic-indicator\" class=\"traffic-low traffic-indicator\">","                            <span id=\"traffic-level-text\">LOW</span> TRAFFIC","                        </div>","                        <div id=\"vehicle-count\" class=\"h4 text-center\">0 vehicles detected</div>","                        <div class=\"mt-3\">","                            <h5>Active Gateways</h5>","                            <ul id=\"gateway-list\" class=\"list-group\">","                                <li class=\"list-group-item\">No gateways active</li>","                            </ul>","                        </div>","                    </div>","                </div>","            </div>","        </div>","","        <div class=\"row mt-4\">","            <div class=\"col-12\">","                <div class=\"card\">","                    <div class=\"card-header\">Recent Traffic Events (Last 5)</div>","                    <div class=\"card-body\">","                        <table class=\"table table-striped\">","                            <thead>","                                <tr>","                                    <th>Time</th>","                                    <th>Gateway</th>","                                    <th>Location</th>","                                    <th>Vehicle Count</th>","                                    <th>Status</th>","                                </tr>","                            </thead>","                            <tbody id=\"event-log\">","                                <tr>","                                    <td colspan=\"5\" class=\"text-center\">Waiting for data...</td>","                                </tr>","                            </tbody>","                        </table>","                    </div>","                </div>","            </div>","        </div>","    </div>","","    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>","    <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>","    <script src=\"https://cdn.socket.io/4.7.4/socket.io.min.js\"></script>","    <script>","        // Initialize map","        const map = L.map('map').setView([0, 0], 2);","        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {","            attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'","        }).addTo(map);","","        // Store markers and data","        const vehicleMarkers = {};","        const gatewayMarkers = {};","        let lastUpdateTime = null;","        let totalVehicles = 0;","        let activeGateways = new Set();","        let eventHistory = [];","","        // Connect to Socket.IO server","        const socket = io();","        ","        socket.on('connect', () => {","            console.log('Connected to fog handler');","            document.getElementById('connection-status').className = 'badge bg-success';","            document.getElementById('connection-status').textContent = 'Connected';","        });","","        socket.on('disconnect', () => {","            console.log('Disconnected from fog handler');","            document.getElementById('connection-status').className = 'badge bg-danger';","            document.getElementById('connection-status').textContent = 'Disconnected';","        });","","        socket.on('init', (data) => {","            console.log('Initial data received:', data);","            // Initialize gateways list","            if (data.gateways && data.gateways.length > 0) {","                data.gateways.forEach(gateway => {","                    activeGateways.add(gateway);","                });","                updateGatewayList();","            }","            ","            // Initialize event log if there's history","            if (data.messages && data.messages.length > 0) {","                eventHistory = data.messages.slice(-5); // Keep only last 5","                updateEventLog();","            }","        });","","        socket.on('update', (data) => {","            console.log('Raw update data:', data);","            ","            // Update last update time","            lastUpdateTime = new Date();","            document.getElementById('last-update').textContent = `Last update: ${lastUpdateTime.toLocaleTimeString()}`;","","            // Update traffic status","            updateTrafficStatus(data.vehicle_count, data.traffic_level);","            ","            // Update gateway list","            updateGatewayList(data.gateway);","            ","            // Add to event history (keep only last 5)","            eventHistory.unshift(data);","            if (eventHistory.length > 5) {","                eventHistory.pop();","            }","            updateEventLog();","            ","            // Update map markers","            updateMapMarkers(data);","        });","","        function updateTrafficStatus(count, level) {","            totalVehicles = count;","            const indicator = document.getElementById('traffic-indicator');","            const levelText = document.getElementById('traffic-level-text');","            ","            // Remove all traffic classes","            indicator.classList.remove('traffic-low', 'traffic-medium', 'traffic-high');","            ","            // Add the appropriate class","            if (level === 'LOW') {","                indicator.classList.add('traffic-low');","                levelText.textContent = 'LOW';","            } else if (level === 'MEDIUM') {","                indicator.classList.add('traffic-medium');","                levelText.textContent = 'MEDIUM';","            } else {","                indicator.classList.add('traffic-high');","                levelText.textContent = 'HEAVY';","            }","            ","            // Update vehicle count display","            document.getElementById('vehicle-count').textContent = ","                `${count} vehicle${count !== 1 ? 's' : ''} detected`;","        }","","        function updateGatewayList(gatewayId) {","            if (gatewayId) {","                activeGateways.add(gatewayId);","            }","            ","            const gatewayList = document.getElementById('gateway-list');","            gatewayList.innerHTML = '';","            ","            if (activeGateways.size === 0) {","                gatewayList.innerHTML = '<li class=\"list-group-item\">No gateways active</li>';","            } else {","                Array.from(activeGateways).sort().forEach(gateway => {","                    const item = document.createElement('li');","                    item.className = 'list-group-item d-flex justify-content-between align-items-center';","                    item.innerHTML = `","                        ${gateway}","                        <span class=\"badge bg-primary rounded-pill\">Active</span>","                    `;","                    gatewayList.appendChild(item);","                });","            }","        }","","        function updateEventLog() {","            const eventLog = document.getElementById('event-log');","            ","            // Clear the \"Waiting for data...\" row if it exists","            if (eventLog.firstChild && eventLog.firstChild.getAttribute('colspan')) {","                eventLog.removeChild(eventLog.firstChild);","            }","            ","            // Clear existing rows","            eventLog.innerHTML = '';","            ","            // Add events to the table (most recent first)","            eventHistory.forEach(event => {","                const row = document.createElement('tr');","                ","                // Highlight rows based on traffic level","                if (event.traffic_level === 'HEAVY') row.classList.add('table-danger');","                else if (event.traffic_level === 'MEDIUM') row.classList.add('table-warning');","                ","                // Parse timestamp","                let timestamp;","                try {","                    timestamp = new Date(event.timestamp);","                    if (isNaN(timestamp.getTime())) {","                        // Fallback for non-ISO formats","                        timestamp = new Date(event.timestamp.replace(' ', 'T') + 'Z');","                    }","                } catch (e) {","                    console.error('Error parsing timestamp:', e);","                    timestamp = new Date();","                }","                ","                row.innerHTML = `","                    <td>${timestamp.toLocaleTimeString()}</td>","                    <td>${event.gateway || 'unknown'}</td>","                    <td>(${event.lat.toFixed(4)}, ${event.lng.toFixed(4)})</td>","                    <td>${event.vehicle_count}</td>","                    <td><span class=\"badge ${getTrafficBadgeClass(event.traffic_level)}\">${event.traffic_level}</span></td>","                `;","                ","                eventLog.appendChild(row);","            });","            ","            // If no events, show a message","            if (eventHistory.length === 0) {","                const row = document.createElement('tr');","                row.innerHTML = '<td colspan=\"5\" class=\"text-center\">No events yet</td>';","                eventLog.appendChild(row);","            }","        }","","        function getTrafficBadgeClass(level) {","            switch(level) {","                case 'LOW': return 'bg-success';","                case 'MEDIUM': return 'bg-warning text-dark';","                case 'HEAVY': return 'bg-danger';","                default: return 'bg-secondary';","            }","        }","","        function updateMapMarkers(data) {","            const lat = data.lat;","            const lng = data.lng;","            const vehicle_count = data.vehicle_count;","            const gateway = data.gateway || 'unknown';","            const traffic_level = data.traffic_level || 'LOW';","            ","            // Update or create vehicle marker","            if (!vehicleMarkers[gateway]) {","                const marker = L.marker([lat, lng], {","                    icon: L.divIcon({","                        className: 'vehicle-marker',","                        html: vehicle_count,","                        iconSize: [20, 20]","                    })","                }).addTo(map);","                ","                marker.bindPopup(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Vehicles:</strong> ${vehicle_count}<br>","                    <strong>Status:</strong> ${traffic_level}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}<br>","                    <strong>Time:</strong> ${new Date(data.timestamp).toLocaleTimeString()}","                `);","                ","                vehicleMarkers[gateway] = marker;","            } else {","                vehicleMarkers[gateway].setLatLng([lat, lng]);","                vehicleMarkers[gateway]._icon.innerHTML = vehicle_count;","                vehicleMarkers[gateway].setPopupContent(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Vehicles:</strong> ${vehicle_count}<br>","                    <strong>Status:</strong> ${traffic_level}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}<br>","                    <strong>Time:</strong> ${new Date(data.timestamp).toLocaleTimeString()}","                `);","            }","            ","            // Update or create gateway marker","            if (!gatewayMarkers[gateway]) {","                const marker = L.marker([lat, lng], {","                    icon: L.divIcon({","                        className: 'gateway-marker',","                        html: 'GW',","                        iconSize: [30, 30]","                    })","                }).addTo(map);","                ","                marker.bindPopup(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Last Update:</strong> ${new Date(data.timestamp).toLocaleTimeString()}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}","                `);","                ","                gatewayMarkers[gateway] = marker;","            } else {","                gatewayMarkers[gateway].setLatLng([lat, lng]);","                gatewayMarkers[gateway].setPopupContent(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Last Update:</strong> ${new Date(data.timestamp).toLocaleTimeString()}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}","                `);","            }","            ","            // Center map on this location with appropriate zoom","            map.setView([lat, lng], 15);","        }","","        // Initial setup","        document.addEventListener('DOMContentLoaded', () => {","            console.log('Dashboard initialized');","        });","    </script>","</body>","</html>"],"id":44}],[{"start":{"row":161,"column":7},"end":{"row":410,"column":11},"action":"remove","lines":[" // Initialize map","        const map = L.map('map').setView([0, 0], 2);","        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {","            attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'","        }).addTo(map);","","        // Store markers and data","        const vehicleMarkers = {};","        const gatewayMarkers = {};","        let lastUpdateTime = null;","        let totalVehicles = 0;","        let activeGateways = new Set();","        let eventHistory = [];","","        // Connect to Socket.IO server","        const socket = io();","        ","        socket.on('connect', () => {","            console.log('Connected to fog handler');","            document.getElementById('connection-status').className = 'badge bg-success';","            document.getElementById('connection-status').textContent = 'Connected';","        });","","        socket.on('disconnect', () => {","            console.log('Disconnected from fog handler');","            document.getElementById('connection-status').className = 'badge bg-danger';","            document.getElementById('connection-status').textContent = 'Disconnected';","        });","","        socket.on('init', (data) => {","            console.log('Initial data received:', data);","            // Initialize gateways list","            if (data.gateways && data.gateways.length > 0) {","                data.gateways.forEach(gateway => {","                    activeGateways.add(gateway);","                });","                updateGatewayList();","            }","            ","            // Initialize event log if there's history","            if (data.messages && data.messages.length > 0) {","                eventHistory = data.messages.slice(-5); // Keep only last 5","                updateEventLog();","            }","        });","","        socket.on('update', (data) => {","            console.log('Raw update data:', data);","            ","            // Update last update time","            lastUpdateTime = new Date();","            document.getElementById('last-update').textContent = `Last update: ${lastUpdateTime.toLocaleTimeString()}`;","","            // Update traffic status","            updateTrafficStatus(data.vehicle_count, data.traffic_level);","            ","            // Update gateway list","            updateGatewayList(data.gateway);","            ","            // Add to event history (keep only last 5)","            eventHistory.unshift(data);","            if (eventHistory.length > 5) {","                eventHistory.pop();","            }","            updateEventLog();","            ","            // Update map markers","            updateMapMarkers(data);","        });","","        function updateTrafficStatus(count, level) {","            totalVehicles = count;","            const indicator = document.getElementById('traffic-indicator');","            const levelText = document.getElementById('traffic-level-text');","            ","            // Remove all traffic classes","            indicator.classList.remove('traffic-low', 'traffic-medium', 'traffic-high');","            ","            // Add the appropriate class","            if (level === 'LOW') {","                indicator.classList.add('traffic-low');","                levelText.textContent = 'LOW';","            } else if (level === 'MEDIUM') {","                indicator.classList.add('traffic-medium');","                levelText.textContent = 'MEDIUM';","            } else {","                indicator.classList.add('traffic-high');","                levelText.textContent = 'HEAVY';","            }","            ","            // Update vehicle count display","            document.getElementById('vehicle-count').textContent = ","                `${count} vehicle${count !== 1 ? 's' : ''} detected`;","        }","","        function updateGatewayList(gatewayId) {","            if (gatewayId) {","                activeGateways.add(gatewayId);","            }","            ","            const gatewayList = document.getElementById('gateway-list');","            gatewayList.innerHTML = '';","            ","            if (activeGateways.size === 0) {","                gatewayList.innerHTML = '<li class=\"list-group-item\">No gateways active</li>';","            } else {","                Array.from(activeGateways).sort().forEach(gateway => {","                    const item = document.createElement('li');","                    item.className = 'list-group-item d-flex justify-content-between align-items-center';","                    item.innerHTML = `","                        ${gateway}","                        <span class=\"badge bg-primary rounded-pill\">Active</span>","                    `;","                    gatewayList.appendChild(item);","                });","            }","        }","","        function updateEventLog() {","            const eventLog = document.getElementById('event-log');","            ","            // Clear the \"Waiting for data...\" row if it exists","            if (eventLog.firstChild && eventLog.firstChild.getAttribute('colspan')) {","                eventLog.removeChild(eventLog.firstChild);","            }","            ","            // Clear existing rows","            eventLog.innerHTML = '';","            ","            // Add events to the table (most recent first)","            eventHistory.forEach(event => {","                const row = document.createElement('tr');","                ","                // Highlight rows based on traffic level","                if (event.traffic_level === 'HEAVY') row.classList.add('table-danger');","                else if (event.traffic_level === 'MEDIUM') row.classList.add('table-warning');","                ","                // Parse timestamp","                let timestamp;","                try {","                    timestamp = new Date(event.timestamp);","                    if (isNaN(timestamp.getTime())) {","                        // Fallback for non-ISO formats","                        timestamp = new Date(event.timestamp.replace(' ', 'T') + 'Z');","                    }","                } catch (e) {","                    console.error('Error parsing timestamp:', e);","                    timestamp = new Date();","                }","                ","                row.innerHTML = `","                    <td>${timestamp.toLocaleTimeString()}</td>","                    <td>${event.gateway || 'unknown'}</td>","                    <td>(${event.lat.toFixed(4)}, ${event.lng.toFixed(4)})</td>","                    <td>${event.vehicle_count}</td>","                    <td><span class=\"badge ${getTrafficBadgeClass(event.traffic_level)}\">${event.traffic_level}</span></td>","                `;","                ","                eventLog.appendChild(row);","            });","            ","            // If no events, show a message","            if (eventHistory.length === 0) {","                const row = document.createElement('tr');","                row.innerHTML = '<td colspan=\"5\" class=\"text-center\">No events yet</td>';","                eventLog.appendChild(row);","            }","        }","","        function getTrafficBadgeClass(level) {","            switch(level) {","                case 'LOW': return 'bg-success';","                case 'MEDIUM': return 'bg-warning text-dark';","                case 'HEAVY': return 'bg-danger';","                default: return 'bg-secondary';","            }","        }","","        function updateMapMarkers(data) {","            const lat = data.lat;","            const lng = data.lng;","            const vehicle_count = data.vehicle_count;","            const gateway = data.gateway || 'unknown';","            const traffic_level = data.traffic_level || 'LOW';","            ","            // Update or create vehicle marker","            if (!vehicleMarkers[gateway]) {","                const marker = L.marker([lat, lng], {","                    icon: L.divIcon({","                        className: 'vehicle-marker',","                        html: vehicle_count,","                        iconSize: [20, 20]","                    })","                }).addTo(map);","                ","                marker.bindPopup(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Vehicles:</strong> ${vehicle_count}<br>","                    <strong>Status:</strong> ${traffic_level}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}<br>","                    <strong>Time:</strong> ${new Date(data.timestamp).toLocaleTimeString()}","                `);","                ","                vehicleMarkers[gateway] = marker;","            } else {","                vehicleMarkers[gateway].setLatLng([lat, lng]);","                vehicleMarkers[gateway]._icon.innerHTML = vehicle_count;","                vehicleMarkers[gateway].setPopupContent(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Vehicles:</strong> ${vehicle_count}<br>","                    <strong>Status:</strong> ${traffic_level}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}<br>","                    <strong>Time:</strong> ${new Date(data.timestamp).toLocaleTimeString()}","                `);","            }","            ","            // Update or create gateway marker","            if (!gatewayMarkers[gateway]) {","                const marker = L.marker([lat, lng], {","                    icon: L.divIcon({","                        className: 'gateway-marker',","                        html: 'GW',","                        iconSize: [30, 30]","                    })","                }).addTo(map);","                ","                marker.bindPopup(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Last Update:</strong> ${new Date(data.timestamp).toLocaleTimeString()}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}","                `);","                ","                gatewayMarkers[gateway] = marker;","            } else {","                gatewayMarkers[gateway].setLatLng([lat, lng]);","                gatewayMarkers[gateway].setPopupContent(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Last Update:</strong> ${new Date(data.timestamp).toLocaleTimeString()}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}","                `);","            }","            ","            // Center map on this location with appropriate zoom","            map.setView([lat, lng], 15);","        }","","        // Initial setup","        document.addEventListener('DOMContentLoaded', () => {","            console.log('Dashboard initialized');","        });"],"id":45},{"start":{"row":161,"column":7},"end":{"row":325,"column":11},"action":"insert","lines":["// Initialize map","        const map = L.map('map').setView([0, 0], 2);","        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {","            attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'","        }).addTo(map);","","        // Store markers and data","        const vehicleMarkers = {};","        const gatewayMarkers = {};","        let lastUpdateTime = null;","        let totalVehicles = 0;","        let activeGateways = new Set();","        let eventHistory = [];","","        // Connect to Socket.IO server with enhanced configuration","        const socket = io({","            reconnection: true,","            reconnectionAttempts: 5,","            reconnectionDelay: 1000,","            timeout: 20000,","            transports: ['websocket']","        });","","        // Connection status handling","        socket.on('connect', () => {","            console.log('‚úÖ Connected to server with ID:', socket.id);","            document.getElementById('connection-status').className = 'badge bg-success';","            document.getElementById('connection-status').textContent = 'Connected';","        });","","        socket.on('connect_error', (err) => {","            console.error('‚ùå Connection error:', err.message);","            document.getElementById('connection-status').className = 'badge bg-danger';","            document.getElementById('connection-status').textContent = 'Connection Failed';","        });","","        socket.on('disconnect', (reason) => {","            console.log('‚ö†Ô∏è Disconnected:', reason);","            document.getElementById('connection-status').className = 'badge bg-warning';","            document.getElementById('connection-status').textContent = 'Disconnected';","            ","            if (reason === 'io server disconnect') {","                // Try to reconnect manually","                socket.connect();","            }","        });","","        // Handle initial data","        socket.on('init', (data) => {","            console.log('üì¶ Initial data:', data);","            if (data.gateways) {","                data.gateways.forEach(gateway => activeGateways.add(gateway));","                updateGatewayList();","            }","            if (data.messages) {","                eventHistory = data.messages.slice(-5).reverse();","                updateEventLog();","            }","        });","","        // Robust update handler","        socket.on('update', (data) => {","            try {","                console.log('üîÑ Update:', data);","                ","                // Validate data structure","                if (!data || typeof data !== 'object') {","                    throw new Error('Invalid data format');","                }","","                // Ensure required fields exist with defaults","                const safeData = {","                    timestamp: data.timestamp || new Date().toISOString(),","                    lat: parseFloat(data.lat) || 0,","                    lng: parseFloat(data.lng) || 0,","                    vehicle_count: parseInt(data.vehicle_count) || 0,","                    gateway: data.gateway || 'unknown',","                    traffic_level: data.traffic_level || 'LOW'","                };","","                // Update UI components","                lastUpdateTime = new Date();","                document.getElementById('last-update').textContent = `Last update: ${lastUpdateTime.toLocaleTimeString()}`;","                ","                updateTrafficStatus(safeData.vehicle_count, safeData.traffic_level);","                updateGatewayList(safeData.gateway);","                ","                // Update event history (keep last 5)","                eventHistory.unshift(safeData);","                if (eventHistory.length > 5) eventHistory.pop();","                updateEventLog();","                ","                updateMapMarkers(safeData);","            } catch (error) {","                console.error('‚ùå Error processing update:', error);","                console.error('Problematic data:', data);","            }","        });","","        // Safer event log update","        function updateEventLog() {","            const eventLog = document.getElementById('event-log');","            ","            // Clear existing content safely","            while (eventLog.firstChild) {","                eventLog.removeChild(eventLog.firstChild);","            }","","            if (eventHistory.length === 0) {","                const row = document.createElement('tr');","                row.innerHTML = '<td colspan=\"5\" class=\"text-center\">Waiting for data...</td>';","                eventLog.appendChild(row);","                return;","            }","","            eventHistory.forEach(event => {","                const row = document.createElement('tr');","                ","                // Highlight based on traffic level","                if (event.traffic_level === 'HEAVY') row.classList.add('table-danger');","                else if (event.traffic_level === 'MEDIUM') row.classList.add('table-warning');","","                // Parse timestamp safely","                let timestamp;","                try {","                    timestamp = new Date(event.timestamp);","                    if (isNaN(timestamp.getTime())) {","                        timestamp = new Date(event.timestamp.replace(' ', 'T') + 'Z';","                    }","                    if (isNaN(timestamp.getTime())) {","                        timestamp = new Date();","                    }","                } catch (e) {","                    console.error('Timestamp error:', e);","                    timestamp = new Date();","                }","","                row.innerHTML = `","                    <td>${timestamp.toLocaleTimeString()}</td>","                    <td>${event.gateway}</td>","                    <td>(${event.lat.toFixed(4)}, ${event.lng.toFixed(4)})</td>","                    <td>${event.vehicle_count}</td>","                    <td><span class=\"badge ${getTrafficBadgeClass(event.traffic_level)}\">${event.traffic_level}</span></td>","                `;","                eventLog.appendChild(row);","            });","        }","","        // Rest of your functions (updateTrafficStatus, updateGatewayList, etc.) remain the same","","        // Connection health check","        document.addEventListener('DOMContentLoaded', () => {","            console.log('Dashboard initialized');","            ","            setTimeout(() => {","                if (!socket.connected) {","                    console.error('‚ùå No connection after 5 seconds');","                    document.getElementById('connection-status').className = 'badge bg-danger';","                    document.getElementById('connection-status').textContent = 'Connection Failed';","                    ","                    // Try to reconnect manually","                    socket.connect();","                }","            }, 5000);","        });"]}],[{"start":{"row":0,"column":0},"end":{"row":328,"column":7},"action":"remove","lines":["<!DOCTYPE html>","<html lang=\"en\">","<head>","    <meta charset=\"UTF-8\">","    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">","    <title>LoRaWAN Traffic Dashboard</title>","    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">","    <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\"/>","    <style>","        body {","            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;","            background-color: #f5f5f5;","        }","        .dashboard-header {","            background-color: #2c3e50;","            color: white;","            padding: 20px 0;","            margin-bottom: 30px;","        }","        .card {","            box-shadow: 0 4px 8px rgba(0,0,0,0.1);","            margin-bottom: 20px;","            border: none;","        }","        .card-header {","            background-color: #3498db;","            color: white;","            font-weight: bold;","        }","        #map {","            height: 500px;","            border-radius: 4px;","        }","        .traffic-indicator {","            font-size: 24px;","            font-weight: bold;","            padding: 10px;","            border-radius: 4px;","            text-align: center;","            margin-bottom: 15px;","        }","        .traffic-low {","            background-color: #2ecc71;","            color: white;","        }","        .traffic-medium {","            background-color: #f39c12;","            color: white;","        }","        .traffic-high {","            background-color: #e74c3c;","            color: white;","        }","        .vehicle-marker {","            background-color: rgba(231, 76, 60, 0.8);","            border-radius: 50%;","            width: 20px;","            height: 20px;","            display: flex;","            justify-content: center;","            align-items: center;","            color: white;","            font-weight: bold;","            font-size: 12px;","        }","        .gateway-marker {","            background-color: rgba(52, 152, 219, 0.8);","            border-radius: 50%;","            width: 30px;","            height: 30px;","            display: flex;","            justify-content: center;","            align-items: center;","            color: white;","            font-weight: bold;","            font-size: 12px;","        }","        #connection-status {","            position: absolute;","            top: 20px;","            right: 20px;","            font-size: 14px;","        }","        .last-update {","            font-size: 12px;","            color: #7f8c8d;","            text-align: right;","            margin-top: 5px;","        }","    </style>","</head>","<body>","    <div class=\"dashboard-header\">","        <div class=\"container position-relative\">","            <h1>LoRaWAN Traffic Monitoring</h1>","            <p>Real-time vehicle tracking from gateways</p>","            <div id=\"connection-status\" class=\"badge bg-secondary\">Connecting...</div>","        </div>","    </div>","","    <div class=\"container\">","        <div class=\"row\">","            <div class=\"col-md-8\">","                <div class=\"card\">","                    <div class=\"card-header\">Traffic Map</div>","                    <div class=\"card-body\">","                        <div id=\"map\"></div>","                        <div class=\"last-update\" id=\"last-update\">No updates yet</div>","                    </div>","                </div>","            </div>","            <div class=\"col-md-4\">","                <div class=\"card\">","                    <div class=\"card-header\">Traffic Status</div>","                    <div class=\"card-body\">","                        <div id=\"traffic-indicator\" class=\"traffic-low traffic-indicator\">","                            <span id=\"traffic-level-text\">LOW</span> TRAFFIC","                        </div>","                        <div id=\"vehicle-count\" class=\"h4 text-center\">0 vehicles detected</div>","                        <div class=\"mt-3\">","                            <h5>Active Gateways</h5>","                            <ul id=\"gateway-list\" class=\"list-group\">","                                <li class=\"list-group-item\">No gateways active</li>","                            </ul>","                        </div>","                    </div>","                </div>","            </div>","        </div>","","        <div class=\"row mt-4\">","            <div class=\"col-12\">","                <div class=\"card\">","                    <div class=\"card-header\">Recent Traffic Events (Last 5)</div>","                    <div class=\"card-body\">","                        <table class=\"table table-striped\">","                            <thead>","                                <tr>","                                    <th>Time</th>","                                    <th>Gateway</th>","                                    <th>Location</th>","                                    <th>Vehicle Count</th>","                                    <th>Status</th>","                                </tr>","                            </thead>","                            <tbody id=\"event-log\">","                                <tr>","                                    <td colspan=\"5\" class=\"text-center\">Waiting for data...</td>","                                </tr>","                            </tbody>","                        </table>","                    </div>","                </div>","            </div>","        </div>","    </div>","","    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>","    <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>","    <script src=\"https://cdn.socket.io/4.7.4/socket.io.min.js\"></script>","    <script>","       // Initialize map","        const map = L.map('map').setView([0, 0], 2);","        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {","            attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'","        }).addTo(map);","","        // Store markers and data","        const vehicleMarkers = {};","        const gatewayMarkers = {};","        let lastUpdateTime = null;","        let totalVehicles = 0;","        let activeGateways = new Set();","        let eventHistory = [];","","        // Connect to Socket.IO server with enhanced configuration","        const socket = io({","            reconnection: true,","            reconnectionAttempts: 5,","            reconnectionDelay: 1000,","            timeout: 20000,","            transports: ['websocket']","        });","","        // Connection status handling","        socket.on('connect', () => {","            console.log('‚úÖ Connected to server with ID:', socket.id);","            document.getElementById('connection-status').className = 'badge bg-success';","            document.getElementById('connection-status').textContent = 'Connected';","        });","","        socket.on('connect_error', (err) => {","            console.error('‚ùå Connection error:', err.message);","            document.getElementById('connection-status').className = 'badge bg-danger';","            document.getElementById('connection-status').textContent = 'Connection Failed';","        });","","        socket.on('disconnect', (reason) => {","            console.log('‚ö†Ô∏è Disconnected:', reason);","            document.getElementById('connection-status').className = 'badge bg-warning';","            document.getElementById('connection-status').textContent = 'Disconnected';","            ","            if (reason === 'io server disconnect') {","                // Try to reconnect manually","                socket.connect();","            }","        });","","        // Handle initial data","        socket.on('init', (data) => {","            console.log('üì¶ Initial data:', data);","            if (data.gateways) {","                data.gateways.forEach(gateway => activeGateways.add(gateway));","                updateGatewayList();","            }","            if (data.messages) {","                eventHistory = data.messages.slice(-5).reverse();","                updateEventLog();","            }","        });","","        // Robust update handler","        socket.on('update', (data) => {","            try {","                console.log('üîÑ Update:', data);","                ","                // Validate data structure","                if (!data || typeof data !== 'object') {","                    throw new Error('Invalid data format');","                }","","                // Ensure required fields exist with defaults","                const safeData = {","                    timestamp: data.timestamp || new Date().toISOString(),","                    lat: parseFloat(data.lat) || 0,","                    lng: parseFloat(data.lng) || 0,","                    vehicle_count: parseInt(data.vehicle_count) || 0,","                    gateway: data.gateway || 'unknown',","                    traffic_level: data.traffic_level || 'LOW'","                };","","                // Update UI components","                lastUpdateTime = new Date();","                document.getElementById('last-update').textContent = `Last update: ${lastUpdateTime.toLocaleTimeString()}`;","                ","                updateTrafficStatus(safeData.vehicle_count, safeData.traffic_level);","                updateGatewayList(safeData.gateway);","                ","                // Update event history (keep last 5)","                eventHistory.unshift(safeData);","                if (eventHistory.length > 5) eventHistory.pop();","                updateEventLog();","                ","                updateMapMarkers(safeData);","            } catch (error) {","                console.error('‚ùå Error processing update:', error);","                console.error('Problematic data:', data);","            }","        });","","        // Safer event log update","        function updateEventLog() {","            const eventLog = document.getElementById('event-log');","            ","            // Clear existing content safely","            while (eventLog.firstChild) {","                eventLog.removeChild(eventLog.firstChild);","            }","","            if (eventHistory.length === 0) {","                const row = document.createElement('tr');","                row.innerHTML = '<td colspan=\"5\" class=\"text-center\">Waiting for data...</td>';","                eventLog.appendChild(row);","                return;","            }","","            eventHistory.forEach(event => {","                const row = document.createElement('tr');","                ","                // Highlight based on traffic level","                if (event.traffic_level === 'HEAVY') row.classList.add('table-danger');","                else if (event.traffic_level === 'MEDIUM') row.classList.add('table-warning');","","                // Parse timestamp safely","                let timestamp;","                try {","                    timestamp = new Date(event.timestamp);","                    if (isNaN(timestamp.getTime())) {","                        timestamp = new Date(event.timestamp.replace(' ', 'T') + 'Z';","                    }","                    if (isNaN(timestamp.getTime())) {","                        timestamp = new Date();","                    }","                } catch (e) {","                    console.error('Timestamp error:', e);","                    timestamp = new Date();","                }","","                row.innerHTML = `","                    <td>${timestamp.toLocaleTimeString()}</td>","                    <td>${event.gateway}</td>","                    <td>(${event.lat.toFixed(4)}, ${event.lng.toFixed(4)})</td>","                    <td>${event.vehicle_count}</td>","                    <td><span class=\"badge ${getTrafficBadgeClass(event.traffic_level)}\">${event.traffic_level}</span></td>","                `;","                eventLog.appendChild(row);","            });","        }","","        // Rest of your functions (updateTrafficStatus, updateGatewayList, etc.) remain the same","","        // Connection health check","        document.addEventListener('DOMContentLoaded', () => {","            console.log('Dashboard initialized');","            ","            setTimeout(() => {","                if (!socket.connected) {","                    console.error('‚ùå No connection after 5 seconds');","                    document.getElementById('connection-status').className = 'badge bg-danger';","                    document.getElementById('connection-status').textContent = 'Connection Failed';","                    ","                    // Try to reconnect manually","                    socket.connect();","                }","            }, 5000);","        });","    </script>","</body>","</html>"],"id":46}],[{"start":{"row":0,"column":0},"end":{"row":334,"column":7},"action":"insert","lines":["<!DOCTYPE html>","<html lang=\"en\">","<head>","    <meta charset=\"UTF-8\">","    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">","    <title>LoRaWAN Traffic Dashboard</title>","    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">","    <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\"/>","    <style>","        body {","            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;","            background-color: #f5f5f5;","        }","        .dashboard-header {","            background-color: #2c3e50;","            color: white;","            padding: 20px 0;","            margin-bottom: 30px;","        }","        .card {","            box-shadow: 0 4px 8px rgba(0,0,0,0.1);","            margin-bottom: 20px;","            border: none;","        }","        .card-header {","            background-color: #3498db;","            color: white;","            font-weight: bold;","        }","        #map {","            height: 500px;","            border-radius: 4px;","        }","        .traffic-indicator {","            font-size: 24px;","            font-weight: bold;","            padding: 10px;","            border-radius: 4px;","            text-align: center;","            margin-bottom: 15px;","        }","        .traffic-low {","            background-color: #2ecc71;","            color: white;","        }","        .traffic-medium {","            background-color: #f39c12;","            color: white;","        }","        .traffic-high {","            background-color: #e74c3c;","            color: white;","        }","        .vehicle-marker {","            background-color: rgba(231, 76, 60, 0.8);","            border-radius: 50%;","            width: 20px;","            height: 20px;","            display: flex;","            justify-content: center;","            align-items: center;","            color: white;","            font-weight: bold;","            font-size: 12px;","        }","        .gateway-marker {","            background-color: rgba(52, 152, 219, 0.8);","            border-radius: 50%;","            width: 30px;","            height: 30px;","            display: flex;","            justify-content: center;","            align-items: center;","            color: white;","            font-weight: bold;","            font-size: 12px;","        }","        #connection-status {","            position: absolute;","            top: 20px;","            right: 20px;","            font-size: 14px;","        }","        .last-update {","            font-size: 12px;","            color: #7f8c8d;","            text-align: right;","            margin-top: 5px;","        }","    </style>","</head>","<body>","    <div class=\"dashboard-header\">","        <div class=\"container position-relative\">","            <h1>LoRaWAN Traffic Monitoring</h1>","            <p>Real-time vehicle tracking from gateways</p>","            <div id=\"connection-status\" class=\"badge bg-secondary\">Connecting...</div>","        </div>","    </div>","","    <div class=\"container\">","        <div class=\"row\">","            <div class=\"col-md-8\">","                <div class=\"card\">","                    <div class=\"card-header\">Traffic Map</div>","                    <div class=\"card-body\">","                        <div id=\"map\"></div>","                        <div class=\"last-update\" id=\"last-update\">No updates yet</div>","                    </div>","                </div>","            </div>","            <div class=\"col-md-4\">","                <div class=\"card\">","                    <div class=\"card-header\">Traffic Status</div>","                    <div class=\"card-body\">","                        <div id=\"traffic-indicator\" class=\"traffic-low traffic-indicator\">","                            <span id=\"traffic-level-text\">LOW</span> TRAFFIC","                        </div>","                        <div id=\"vehicle-count\" class=\"h4 text-center\">0 vehicles detected</div>","                        <div class=\"mt-3\">","                            <h5>Active Gateways</h5>","                            <ul id=\"gateway-list\" class=\"list-group\">","                                <li class=\"list-group-item\">No gateways active</li>","                            </ul>","                        </div>","                    </div>","                </div>","            </div>","        </div>","    </div>","","    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>","    <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>","    <script src=\"https://cdn.socket.io/4.7.4/socket.io.min.js\"></script>","    <script>","        // Initialize map","        const map = L.map('map').setView([0, 0], 2);","        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {","            attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'","        }).addTo(map);","","        // Store markers and data","        const vehicleMarkers = {};","        const gatewayMarkers = {};","        let lastUpdateTime = null;","        let totalVehicles = 0;","        let activeGateways = new Set();","","        // Connect to Socket.IO server with enhanced configuration","        const socket = io({","            reconnection: true,","            reconnectionAttempts: 5,","            reconnectionDelay: 1000,","            timeout: 20000,","            transports: ['websocket']","        });","","        // Connection status handling","        socket.on('connect', () => {","            console.log('‚úÖ Connected to server with ID:', socket.id);","            document.getElementById('connection-status').className = 'badge bg-success';","            document.getElementById('connection-status').textContent = 'Connected';","        });","","        socket.on('connect_error', (err) => {","            console.error('‚ùå Connection error:', err.message);","            document.getElementById('connection-status').className = 'badge bg-danger';","            document.getElementById('connection-status').textContent = 'Connection Failed';","        });","","        socket.on('disconnect', (reason) => {","            console.log('‚ö†Ô∏è Disconnected:', reason);","            document.getElementById('connection-status').className = 'badge bg-warning';","            document.getElementById('connection-status').textContent = 'Disconnected';","            ","            if (reason === 'io server disconnect') {","                socket.connect();","            }","        });","","        // Handle updates","        socket.on('update', (data) => {","            try {","                console.log('üîÑ Update:', data);","                ","                // Validate and prepare data","                const safeData = {","                    timestamp: data.timestamp || new Date().toISOString(),","                    lat: parseFloat(data.lat) || 0,","                    lng: parseFloat(data.lng) || 0,","                    vehicle_count: parseInt(data.vehicle_count) || 0,","                    gateway: data.gateway || 'unknown',","                    traffic_level: data.traffic_level || 'LOW'","                };","","                // Update UI","                lastUpdateTime = new Date();","                document.getElementById('last-update').textContent = `Last update: ${lastUpdateTime.toLocaleTimeString()}`;","                ","                updateTrafficStatus(safeData.vehicle_count, safeData.traffic_level);","                updateGatewayList(safeData.gateway);","                updateMapMarkers(safeData);","            } catch (error) {","                console.error('‚ùå Error processing update:', error);","            }","        });","","        function updateTrafficStatus(count, level) {","            totalVehicles = count;","            const indicator = document.getElementById('traffic-indicator');","            const levelText = document.getElementById('traffic-level-text');","            ","            indicator.classList.remove('traffic-low', 'traffic-medium', 'traffic-high');","            ","            if (level === 'LOW') {","                indicator.classList.add('traffic-low');","                levelText.textContent = 'LOW';","            } else if (level === 'MEDIUM') {","                indicator.classList.add('traffic-medium');","                levelText.textContent = 'MEDIUM';","            } else {","                indicator.classList.add('traffic-high');","                levelText.textContent = 'HEAVY';","            }","            ","            document.getElementById('vehicle-count').textContent = ","                `${count} vehicle${count !== 1 ? 's' : ''} detected`;","        }","","        function updateGatewayList(gatewayId) {","            if (gatewayId) {","                activeGateways.add(gatewayId);","            }","            ","            const gatewayList = document.getElementById('gateway-list');","            gatewayList.innerHTML = '';","            ","            if (activeGateways.size === 0) {","                gatewayList.innerHTML = '<li class=\"list-group-item\">No gateways active</li>';","            } else {","                Array.from(activeGateways).sort().forEach(gateway => {","                    const item = document.createElement('li');","                    item.className = 'list-group-item d-flex justify-content-between align-items-center';","                    item.innerHTML = `","                        ${gateway}","                        <span class=\"badge bg-primary rounded-pill\">Active</span>","                    `;","                    gatewayList.appendChild(item);","                });","            }","        }","","        function updateMapMarkers(data) {","            const lat = data.lat;","            const lng = data.lng;","            const vehicle_count = data.vehicle_count;","            const gateway = data.gateway || 'unknown';","            const traffic_level = data.traffic_level || 'LOW';","            ","            // Vehicle marker","            if (!vehicleMarkers[gateway]) {","                const marker = L.marker([lat, lng], {","                    icon: L.divIcon({","                        className: 'vehicle-marker',","                        html: vehicle_count,","                        iconSize: [20, 20]","                    })","                }).addTo(map);","                ","                marker.bindPopup(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Vehicles:</strong> ${vehicle_count}<br>","                    <strong>Status:</strong> ${traffic_level}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}<br>","                    <strong>Time:</strong> ${new Date(data.timestamp).toLocaleTimeString()}","                `);","                ","                vehicleMarkers[gateway] = marker;","            } else {","                vehicleMarkers[gateway].setLatLng([lat, lng]);","                vehicleMarkers[gateway]._icon.innerHTML = vehicle_count;","                vehicleMarkers[gateway].setPopupContent(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Vehicles:</strong> ${vehicle_count}<br>","                    <strong>Status:</strong> ${traffic_level}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}<br>","                    <strong>Time:</strong> ${new Date(data.timestamp).toLocaleTimeString()}","                `);","            }","            ","            // Gateway marker","            if (!gatewayMarkers[gateway]) {","                const marker = L.marker([lat, lng], {","                    icon: L.divIcon({","                        className: 'gateway-marker',","                        html: 'GW',","                        iconSize: [30, 30]","                    })","                }).addTo(map);","                ","                marker.bindPopup(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Last Update:</strong> ${new Date(data.timestamp).toLocaleTimeString()}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}","                `);","                ","                gatewayMarkers[gateway] = marker;","            } else {","                gatewayMarkers[gateway].setLatLng([lat, lng]);","                gatewayMarkers[gateway].setPopupContent(`","                    <strong>Gateway:</strong> ${gateway}<br>","                    <strong>Last Update:</strong> ${new Date(data.timestamp).toLocaleTimeString()}<br>","                    <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}","                `);","            }","            ","            map.setView([lat, lng], 15);","        }","","        // Initial setup","        document.addEventListener('DOMContentLoaded', () => {","            console.log('Dashboard initialized');","            ","            setTimeout(() => {","                if (!socket.connected) {","                    console.error('‚ùå No connection after 5 seconds');","                    document.getElementById('connection-status').className = 'badge bg-danger';","                    document.getElementById('connection-status').textContent = 'Connection Failed';","                    socket.connect();","                }","            }, 5000);","        });","    </script>","</body>","</html>"],"id":47}],[{"start":{"row":111,"column":12},"end":{"row":130,"column":0},"action":"remove","lines":["<div class=\"col-md-4\">","                <div class=\"card\">","                    <div class=\"card-header\">Traffic Status</div>","                    <div class=\"card-body\">","                        <div id=\"traffic-indicator\" class=\"traffic-low traffic-indicator\">","                            <span id=\"traffic-level-text\">LOW</span> TRAFFIC","                        </div>","                        <div id=\"vehicle-count\" class=\"h4 text-center\">0 vehicles detected</div>","                        <div class=\"mt-3\">","                            <h5>Active Gateways</h5>","                            <ul id=\"gateway-list\" class=\"list-group\">","                                <li class=\"list-group-item\">No gateways active</li>","                            </ul>","                        </div>","                    </div>","                </div>","            </div>","        </div>","    </div>",""],"id":48}]]},"ace":{"folds":[],"scrolltop":4687.5,"scrollleft":0,"selection":{"start":{"row":334,"column":7},"end":{"row":334,"column":7},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1754653659443}